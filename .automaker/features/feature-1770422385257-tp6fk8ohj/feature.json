{
  "category": "Uncategorized",
  "description": "TASK 1: Add SSRF Protection to HTTP Dispatcher\nPriority: CRITICAL | Type: Security fix | Estimated scope: 2 files + 1 test file\n\nContext:\nThe HTTP dispatcher at packages/adapter-http/src/http-dispatcher.ts:51 calls fetch(ep.url, ...) with user-supplied URLs and performs zero validation on the destination. Users create endpoints via the API with any URL (validated only as z.string().url() in packages/api-contracts/src/jobs/schemas.ts:134). The scheduler then executes those URLs. This is a textbook SSRF vulnerability â€” a user can point an endpoint at http://169.254.169.254/latest/meta-data/ (AWS metadata), http://localhost:5432 (the database), or any internal service.\n\nWhat to implement:\n\nCreate a new file packages/adapter-http/src/url-validator.ts that exports a function assertUrlAllowed(url: string): void which throws if the URL targets:\n\nLocalhost: 127.0.0.0/8, ::1, localhost\nPrivate ranges: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16\nLink-local: 169.254.0.0/16 (AWS/GCP/Azure metadata), fe80::/10\nIPv6 unique local: fc00::/7\nNon-HTTP schemes (must be http: or https:)\nThe function must resolve DNS hostnames before checking (a hostname like metadata.internal could resolve to 169.254.169.254). Use dns.promises.lookup() from Node.js to resolve the hostname and validate the resolved IP.\nCall assertUrlAllowed(ep.url) in packages/adapter-http/src/http-dispatcher.ts before the fetch() call at line 51. If it throws, return an ExecutionResult with status \"failed\" and the error message, rather than crashing the scheduler.\n\nAdd unit tests in packages/adapter-http/src/__tests__/url-validator.test.ts covering:\n\nBlocked: http://127.0.0.1/path, http://localhost:8080, http://169.254.169.254/latest/, http://10.0.0.1, http://192.168.1.1, http://[::1]/path, ftp://example.com\nAllowed: https://example.com, https://api.stripe.com/v1/charges, http://203.0.113.50:8080\nConventions:\n\nFile naming: kebab-case (url-validator.ts)\nNo console.log â€” use the logger port if logging is needed\nNo any types\nUse .js extensions in imports\nThe adapter package is at packages/adapter-http/, tests go in src/__tests__/\nRun pnpm test and pnpm lint after changes",
  "title": "Add SSRF protection to HTTP dispatcher",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-1770422385257-tp6fk8ohj",
  "descriptionHistory": [
    {
      "description": "TASK 1: Add SSRF Protection to HTTP Dispatcher\nPriority: CRITICAL | Type: Security fix | Estimated scope: 2 files + 1 test file\n\nContext:\nThe HTTP dispatcher at packages/adapter-http/src/http-dispatcher.ts:51 calls fetch(ep.url, ...) with user-supplied URLs and performs zero validation on the destination. Users create endpoints via the API with any URL (validated only as z.string().url() in packages/api-contracts/src/jobs/schemas.ts:134). The scheduler then executes those URLs. This is a textbook SSRF vulnerability â€” a user can point an endpoint at http://169.254.169.254/latest/meta-data/ (AWS metadata), http://localhost:5432 (the database), or any internal service.\n\nWhat to implement:\n\nCreate a new file packages/adapter-http/src/url-validator.ts that exports a function assertUrlAllowed(url: string): void which throws if the URL targets:\n\nLocalhost: 127.0.0.0/8, ::1, localhost\nPrivate ranges: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16\nLink-local: 169.254.0.0/16 (AWS/GCP/Azure metadata), fe80::/10\nIPv6 unique local: fc00::/7\nNon-HTTP schemes (must be http: or https:)\nThe function must resolve DNS hostnames before checking (a hostname like metadata.internal could resolve to 169.254.169.254). Use dns.promises.lookup() from Node.js to resolve the hostname and validate the resolved IP.\nCall assertUrlAllowed(ep.url) in packages/adapter-http/src/http-dispatcher.ts before the fetch() call at line 51. If it throws, return an ExecutionResult with status \"failed\" and the error message, rather than crashing the scheduler.\n\nAdd unit tests in packages/adapter-http/src/__tests__/url-validator.test.ts covering:\n\nBlocked: http://127.0.0.1/path, http://localhost:8080, http://169.254.169.254/latest/, http://10.0.0.1, http://192.168.1.1, http://[::1]/path, ftp://example.com\nAllowed: https://example.com, https://api.stripe.com/v1/charges, http://203.0.113.50:8080\nConventions:\n\nFile naming: kebab-case (url-validator.ts)\nNo console.log â€” use the logger port if logging is needed\nNo any types\nUse .js extensions in imports\nThe adapter package is at packages/adapter-http/, tests go in src/__tests__/\nRun pnpm test and pnpm lint after changes",
      "timestamp": "2026-02-06T23:59:45.556Z",
      "source": "initial"
    }
  ],
  "startedAt": "2026-02-07T00:00:19.163Z",
  "updatedAt": "2026-02-07T00:20:22.799Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/packages/adapter-http/src/http-dispatcher.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"packages/adapter-http/src/**/*.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/packages/api-contracts/src/jobs/schemas.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/adapter-http/src/http-dispatcher.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/adapter-http/src/__tests__/http-dispatcher.test.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/adapter-http/src/index.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"packages/api-contracts/src/**/*.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/api-contracts/src/jobs/schemas.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/adapter-http/src/fake-http-dispatcher.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"packages/domain/src/**/*.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/domain/src/ports/external.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/adapter-http/package.json\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"packages/adapter-http/tsconfig*.json\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/domain/src/ports/services.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/domain/src/entities/endpoint.ts\"\n}\n# SSRF Protection for HTTP Dispatcher\n\n## 1. Problem\n\nThe HTTP dispatcher (`packages/adapter-http/src/http-dispatcher.ts`) executes `fetch()` calls with user-supplied URLs without validating the destination. Users can submit any URL through the API (only validated as `z.string().url()`), allowing requests to internal services, cloud metadata endpoints (e.g., `169.254.169.254`), localhost, or private network ranges. This is a critical Server-Side Request Forgery (SSRF) vulnerability.\n\n## 2. Solution\n\nCreate a URL validation module that resolves hostnames via DNS and validates the resulting IP addresses against a blocklist of internal/private ranges. Integrate this validator into the HTTP dispatcher to block SSRF attempts before executing fetch requests.\n\n## 3. Acceptance Criteria\n\n- **GIVEN** a URL targeting localhost (127.0.0.1, ::1, localhost), **WHEN** the dispatcher attempts to execute, **THEN** it returns a failed ExecutionResult with an appropriate error message\n- **GIVEN** a URL targeting private ranges (10.x.x.x, 172.16-31.x.x, 192.168.x.x), **WHEN** the dispatcher attempts to execute, **THEN** it returns a failed ExecutionResult\n- **GIVEN** a URL targeting cloud metadata endpoints (169.254.x.x), **WHEN** the dispatcher attempts to execute, **THEN** it returns a failed ExecutionResult\n- **GIVEN** a URL with non-HTTP scheme (ftp://, file://), **WHEN** the dispatcher attempts to execute, **THEN** it returns a failed ExecutionResult\n- **GIVEN** a URL targeting a public IP (e.g., api.stripe.com), **WHEN** the dispatcher attempts to execute, **THEN** the request proceeds normally\n\n## 4. Files to Modify\n\n| File | Purpose | Action |\n|------|---------|--------|\n| `packages/adapter-http/src/url-validator.ts` | URL validation logic with DNS resolution and IP blocklist checking | create |\n| `packages/adapter-http/src/http-dispatcher.ts` | Add SSRF protection check before fetch() call | modify |\n| `packages/adapter-http/src/index.ts` | Export new URL validator utilities | modify |\n| `packages/adapter-http/src/__tests__/url-validator.test.ts` | Unit tests for URL validator | create |\n\n## 5. Implementation Tasks\n\n```tasks\n- [ ] T001: Create url-validator.ts with assertUrlAllowed function | File: packages/adapter-http/src/url-validator.ts\n- [ ] T002: Implement IP range checking for localhost, private, link-local, and IPv6 ranges | File: packages/adapter-http/src/url-validator.ts\n- [ ] T003: Implement DNS hostname resolution before IP validation | File: packages/adapter-http/src/url-validator.ts\n- [ ] T004: Implement HTTP/HTTPS scheme validation | File: packages/adapter-http/src/url-validator.ts\n- [ ] T005: Integrate assertUrlAllowed into HttpDispatcher before fetch() | File: packages/adapter-http/src/http-dispatcher.ts\n- [ ] T006: Export url-validator utilities from index.ts | File: packages/adapter-http/src/index.ts\n- [ ] T007: Create unit tests for blocked URLs (localhost, private, metadata, IPv6, non-HTTP) | File: packages/adapter-http/src/__tests__/url-validator.test.ts\n- [ ] T008: Create unit tests for allowed URLs (public domains, public IPs) | File: packages/adapter-http/src/__tests__/url-validator.test.ts\n- [ ] T009: Run pnpm test and pnpm lint to verify changes | File: N/A\n```\n\n## 6. Verification\n\n1. Run unit tests: `pnpm test` in `packages/adapter-http`\n2. Run linter: `pnpm lint`\n3. Manual verification of test coverage:\n   - Blocked: `http://127.0.0.1/path`, `http://localhost:8080`, `http://169.254.169.254/latest/`, `http://10.0.0.1`, `http://192.168.1.1`, `http://[::1]/path`, `ftp://example.com`\n   - Allowed: `https://example.com`, `https://api.stripe.com/v1/charges`, `http://203.0.113.50:8080`",
    "generatedAt": "2026-02-07T00:01:32.321Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Create url-validator.ts with assertUrlAllowed function",
        "filePath": "packages/adapter-http/src/url-validator.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Implement IP range checking for localhost, private, link-local, and IPv6 ranges",
        "filePath": "packages/adapter-http/src/url-validator.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Implement DNS hostname resolution before IP validation",
        "filePath": "packages/adapter-http/src/url-validator.ts",
        "status": "pending"
      },
      {
        "id": "T004",
        "description": "Implement HTTP/HTTPS scheme validation",
        "filePath": "packages/adapter-http/src/url-validator.ts",
        "status": "pending"
      },
      {
        "id": "T005",
        "description": "Integrate assertUrlAllowed into HttpDispatcher before fetch()",
        "filePath": "packages/adapter-http/src/http-dispatcher.ts",
        "status": "pending"
      },
      {
        "id": "T006",
        "description": "Export url-validator utilities from index.ts",
        "filePath": "packages/adapter-http/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T007",
        "description": "Create unit tests for blocked URLs (localhost, private, metadata, IPv6, non-HTTP)",
        "filePath": "packages/adapter-http/src/__tests__/url-validator.test.ts",
        "status": "pending"
      },
      {
        "id": "T008",
        "description": "Create unit tests for allowed URLs (public domains, public IPs)",
        "filePath": "packages/adapter-http/src/__tests__/url-validator.test.ts",
        "status": "pending"
      },
      {
        "id": "T009",
        "description": "Run pnpm test and pnpm lint to verify changes",
        "filePath": "N/A",
        "status": "pending"
      }
    ],
    "tasksTotal": 9,
    "tasksCompleted": 9,
    "approvedAt": "2026-02-07T00:01:32.323Z",
    "currentTaskId": "T009"
  },
  "justFinishedAt": "2026-02-07T00:20:22.799Z"
}