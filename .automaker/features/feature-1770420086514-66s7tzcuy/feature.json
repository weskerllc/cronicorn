{
  "category": "Uncategorized",
  "description": "TASK 14: Add Graceful Shutdown Timeout\nPriority: MEDIUM | Type: Resilience | Estimated scope: 2 files\n\nContext:\nThe scheduler at apps/scheduler/src/index.ts:152-155 waits indefinitely for the current tick to complete during shutdown: if (currentTick) { await currentTick; }. If a tick hangs (e.g., an endpoint takes 5 minutes to respond), the process never exits and the orchestrator (Docker, Kubernetes) has to SIGKILL it.\n\nWhat to implement:\n\nIn apps/scheduler/src/index.ts, add a shutdown timeout in the shutdown() function (line 147):\n\nconst SHUTDOWN_TIMEOUT_MS = 30000; // 30 seconds\n\nif (currentTick) {\n  logger.info(\"Waiting for current tick to complete\");\n  const timeout = new Promise<void>((resolve) => \n    setTimeout(() => {\n      logger.warn(\"Shutdown timeout reached, forcing exit\");\n      resolve();\n    }, SHUTDOWN_TIMEOUT_MS)\n  );\n  await Promise.race([currentTick, timeout]);\n}\n\nAdd SHUTDOWN_TIMEOUT_MS to the scheduler's configSchema (line 23-34) with default 30000.\n\nApply the same pattern to apps/api/src/index.ts shutdown handler (line 42-63) â€” add a timeout around db.$client.end().\n\nApply to apps/ai-planner/src/index.ts if it has a similar shutdown handler.\n\nConventions:\n\nCommit as feat(workers): add configurable shutdown timeout",
  "title": "Add configurable shutdown timeout for graceful process termination",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-1770420086514-66s7tzcuy",
  "descriptionHistory": [
    {
      "description": "TASK 14: Add Graceful Shutdown Timeout\nPriority: MEDIUM | Type: Resilience | Estimated scope: 2 files\n\nContext:\nThe scheduler at apps/scheduler/src/index.ts:152-155 waits indefinitely for the current tick to complete during shutdown: if (currentTick) { await currentTick; }. If a tick hangs (e.g., an endpoint takes 5 minutes to respond), the process never exits and the orchestrator (Docker, Kubernetes) has to SIGKILL it.\n\nWhat to implement:\n\nIn apps/scheduler/src/index.ts, add a shutdown timeout in the shutdown() function (line 147):\n\nconst SHUTDOWN_TIMEOUT_MS = 30000; // 30 seconds\n\nif (currentTick) {\n  logger.info(\"Waiting for current tick to complete\");\n  const timeout = new Promise<void>((resolve) => \n    setTimeout(() => {\n      logger.warn(\"Shutdown timeout reached, forcing exit\");\n      resolve();\n    }, SHUTDOWN_TIMEOUT_MS)\n  );\n  await Promise.race([currentTick, timeout]);\n}\n\nAdd SHUTDOWN_TIMEOUT_MS to the scheduler's configSchema (line 23-34) with default 30000.\n\nApply the same pattern to apps/api/src/index.ts shutdown handler (line 42-63) â€” add a timeout around db.$client.end().\n\nApply to apps/ai-planner/src/index.ts if it has a similar shutdown handler.\n\nConventions:\n\nCommit as feat(workers): add configurable shutdown timeout",
      "timestamp": "2026-02-06T23:21:26.861Z",
      "source": "initial"
    }
  ],
  "branchName": "proddd",
  "startedAt": "2026-02-07T05:45:52.104Z",
  "updatedAt": "2026-02-07T05:55:18.374Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/scheduler/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/ai-planner/src/index.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/scheduler/**/index.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/api/**/index.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/ai-planner/**/index.ts\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"find . -type f -name \\\"*.ts\\\" 2>/dev/null | head -50\",\n  \"description\": \"Find TypeScript files in codebase\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/*.ts\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"ls -la\",\n  \"description\": \"List root directory contents\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"ls -la apps/\",\n  \"description\": \"List apps directory contents\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Projects/rcm/apps/scheduler/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Projects/rcm/apps/api/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Projects/rcm/apps/ai-planner/src/index.ts\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"pwd\",\n  \"description\": \"Get current working directory\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/scheduler/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/ai-planner/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/config.ts\"\n}\n# Specification: Add Graceful Shutdown Timeout\n\n## 1. Problem\n\nWhen a worker receives a shutdown signal (SIGTERM/SIGINT), it waits indefinitely for the current tick/analysis to complete. If an operation hangs (e.g., an endpoint takes 5+ minutes to respond), the process never exits, forcing container orchestrators (Docker, Kubernetes) to use SIGKILL, potentially leaving state inconsistent.\n\n## 2. Solution\n\nAdd a configurable shutdown timeout using `Promise.race()` to limit how long each worker waits for in-flight operations. If the timeout is reached, log a warning and proceed with shutdown, allowing graceful exit even when operations hang.\n\n## 3. Acceptance Criteria\n\n- GIVEN a scheduler worker with a hanging tick, WHEN shutdown signal is received, THEN the worker exits within SHUTDOWN_TIMEOUT_MS (default 30 seconds) with a warning log\n- GIVEN an API server with a slow database connection close, WHEN shutdown signal is received, THEN the server exits within SHUTDOWN_TIMEOUT_MS with a warning log\n- GIVEN an AI planner with a hanging analysis, WHEN shutdown signal is received, THEN the worker exits within SHUTDOWN_TIMEOUT_MS with a warning log\n- GIVEN SHUTDOWN_TIMEOUT_MS environment variable is set to a custom value, WHEN worker starts, THEN it uses the custom timeout value\n- GIVEN a worker completing normally within timeout, WHEN shutdown signal is received, THEN no timeout warning is logged\n\n## 4. Files to Modify\n\n| File | Purpose | Action |\n|------|---------|--------|\n| apps/scheduler/src/index.ts | Add timeout to shutdown handler, add config option | modify |\n| apps/api/src/index.ts | Add timeout to shutdown handler | modify |\n| apps/api/src/lib/config.ts | Add SHUTDOWN_TIMEOUT_MS to config schema | modify |\n| apps/ai-planner/src/index.ts | Add timeout to shutdown handler, add config option | modify |\n\n## 5. Implementation Tasks\n\n```tasks\n- [ ] T001: Add SHUTDOWN_TIMEOUT_MS to scheduler configSchema with default 30000ms | File: apps/scheduler/src/index.ts\n- [ ] T002: Implement shutdown timeout logic in scheduler shutdown() function using Promise.race | File: apps/scheduler/src/index.ts\n- [ ] T003: Add SHUTDOWN_TIMEOUT_MS to API config schema with default 30000ms | File: apps/api/src/lib/config.ts\n- [ ] T004: Implement shutdown timeout logic in API shutdown handler using Promise.race | File: apps/api/src/index.ts\n- [ ] T005: Add SHUTDOWN_TIMEOUT_MS to ai-planner configSchema with default 30000ms | File: apps/ai-planner/src/index.ts\n- [ ] T006: Implement shutdown timeout logic in ai-planner shutdown() function using Promise.race | File: apps/ai-planner/src/index.ts\n```\n\n## 6. Verification\n\n1. **Unit verification**: Manually test by adding a `setTimeout` delay in a tick/handler and sending SIGTERM; verify timeout warning appears and process exits within ~30 seconds\n2. **Config verification**: Set `SHUTDOWN_TIMEOUT_MS=5000` and verify the custom timeout is used\n3. **Normal operation verification**: Verify that when operations complete quickly, no timeout warning is logged\n4. **Log verification**: Check logs show:\n   - \"Waiting for current tick/analysis to complete\" when in-flight work exists\n   - \"Shutdown timeout reached, forcing exit\" when timeout is triggered\n   - \"Worker shutdown complete\" when done",
    "generatedAt": "2026-02-07T05:47:31.510Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Add SHUTDOWN_TIMEOUT_MS to scheduler configSchema with default 30000ms",
        "filePath": "apps/scheduler/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Implement shutdown timeout logic in scheduler shutdown() function using Promise.race",
        "filePath": "apps/scheduler/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Add SHUTDOWN_TIMEOUT_MS to API config schema with default 30000ms",
        "filePath": "apps/api/src/lib/config.ts",
        "status": "pending"
      },
      {
        "id": "T004",
        "description": "Implement shutdown timeout logic in API shutdown handler using Promise.race",
        "filePath": "apps/api/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T005",
        "description": "Add SHUTDOWN_TIMEOUT_MS to ai-planner configSchema with default 30000ms",
        "filePath": "apps/ai-planner/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T006",
        "description": "Implement shutdown timeout logic in ai-planner shutdown() function using Promise.race",
        "filePath": "apps/ai-planner/src/index.ts",
        "status": "pending"
      }
    ],
    "tasksTotal": 6,
    "tasksCompleted": 6,
    "approvedAt": "2026-02-07T05:47:31.513Z",
    "currentTaskId": "T006"
  },
  "justFinishedAt": "2026-02-07T05:55:18.374Z"
}
