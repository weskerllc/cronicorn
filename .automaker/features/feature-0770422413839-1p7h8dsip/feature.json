{
  "category": "Uncategorized",
  "description": "TASK 2: Fix Refund Double-Charge Bug\nPriority: CRITICAL | Type: Bug fix | Estimated scope: 1 file + 1 test file\n\nContext:\nIn packages/services/src/subscriptions/manager.ts:117-207, the requestRefund() method has a critical ordering bug. The current flow:\n\nLine 153: Set refundStatus = \"requested\" in DB\nLine 165: Call paymentProvider.issueRefund() â€” this commits money in Stripe (irreversible)\nLine 177: Call paymentProvider.cancelSubscriptionNow() â€” this can fail\nLine 185: Update DB to tier: \"free\", refundStatus: \"issued\"\nIf step 3 fails, the catch block at line 200-205 rolls refundStatus back to \"eligible\". But the refund was already issued in Stripe at step 2. The user can then request another refund and get double their money back.\n\nWhat to implement:\n\nIn packages/services/src/subscriptions/manager.ts, reorder the requestRefund() method:\n\nStep 1: Set refundStatus = \"requested\" (keep as-is)\nStep 2: Cancel subscription first (cancelSubscriptionNow)\nStep 3: Issue refund second (issueRefund)\nStep 4: Update DB to final state\nIn the catch block: if the refund was already issued (track with a local boolean), set refundStatus = \"issued\" instead of \"eligible\". If only cancellation succeeded, set a new status \"cancel_failed\" or keep as \"requested\" so it can be retried but not re-initiated.\nIn the catch block, differentiate between:\n\nCancel failed (before refund): safe to retry, keep refundStatus = \"requested\"\nRefund failed (after cancel): set refundStatus = \"cancel_completed_refund_failed\" or similar â€” log and alert, needs manual intervention\nBoth succeeded but DB update failed: set refundStatus = \"issued\" as a fallback\nAdd tests in packages/services/src/subscriptions/__tests__/manager.test.ts:\n\nTest: cancelSubscriptionNow throws â†’ refund is NOT issued, status stays \"requested\", no money leaves\nTest: issueRefund throws after cancel succeeds â†’ status reflects partial completion\nTest: successful full flow (already exists, verify it still passes)\nKey files to read first:\n\npackages/services/src/subscriptions/manager.ts (full file, especially lines 117-207)\npackages/services/src/subscriptions/__tests__/manager.test.ts (understand mock patterns, lines 24-50 for mock factories, lines 452-516 for existing refund tests)\nConventions:\n\nFollow conventional commits: fix(subscriptions): prevent double-refund on partial failure\nNo any types â€” the existing test file uses typed mocks\nRun pnpm test after changes",
  "title": "Fix subscription refund double-charge bug",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-0770422413839-1p7h8dsip",
  "descriptionHistory": [
    {
      "description": "TASK 2: Fix Refund Double-Charge Bug\nPriority: CRITICAL | Type: Bug fix | Estimated scope: 1 file + 1 test file\n\nContext:\nIn packages/services/src/subscriptions/manager.ts:117-207, the requestRefund() method has a critical ordering bug. The current flow:\n\nLine 153: Set refundStatus = \"requested\" in DB\nLine 165: Call paymentProvider.issueRefund() â€” this commits money in Stripe (irreversible)\nLine 177: Call paymentProvider.cancelSubscriptionNow() â€” this can fail\nLine 185: Update DB to tier: \"free\", refundStatus: \"issued\"\nIf step 3 fails, the catch block at line 200-205 rolls refundStatus back to \"eligible\". But the refund was already issued in Stripe at step 2. The user can then request another refund and get double their money back.\n\nWhat to implement:\n\nIn packages/services/src/subscriptions/manager.ts, reorder the requestRefund() method:\n\nStep 1: Set refundStatus = \"requested\" (keep as-is)\nStep 2: Cancel subscription first (cancelSubscriptionNow)\nStep 3: Issue refund second (issueRefund)\nStep 4: Update DB to final state\nIn the catch block: if the refund was already issued (track with a local boolean), set refundStatus = \"issued\" instead of \"eligible\". If only cancellation succeeded, set a new status \"cancel_failed\" or keep as \"requested\" so it can be retried but not re-initiated.\nIn the catch block, differentiate between:\n\nCancel failed (before refund): safe to retry, keep refundStatus = \"requested\"\nRefund failed (after cancel): set refundStatus = \"cancel_completed_refund_failed\" or similar â€” log and alert, needs manual intervention\nBoth succeeded but DB update failed: set refundStatus = \"issued\" as a fallback\nAdd tests in packages/services/src/subscriptions/__tests__/manager.test.ts:\n\nTest: cancelSubscriptionNow throws â†’ refund is NOT issued, status stays \"requested\", no money leaves\nTest: issueRefund throws after cancel succeeds â†’ status reflects partial completion\nTest: successful full flow (already exists, verify it still passes)\nKey files to read first:\n\npackages/services/src/subscriptions/manager.ts (full file, especially lines 117-207)\npackages/services/src/subscriptions/__tests__/manager.test.ts (understand mock patterns, lines 24-50 for mock factories, lines 452-516 for existing refund tests)\nConventions:\n\nFollow conventional commits: fix(subscriptions): prevent double-refund on partial failure\nNo any types â€” the existing test file uses typed mocks\nRun pnpm test after changes",
      "timestamp": "2026-02-07T00:00:02.098Z",
      "source": "initial"
    }
  ],
  "branchName": "proddd",
  "startedAt": "2026-02-07T00:47:33.597Z",
  "updatedAt": "2026-02-07T00:57:36.557Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/packages/services/src/subscriptions/manager.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/packages/services/src/subscriptions/__tests__/manager.test.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/subscriptions/**/*.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/manager.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/services/src/subscriptions/manager.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/services/src/subscriptions/__tests__/manager.test.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/services/src/subscriptions/errors.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/services/src/subscriptions/types.ts\"\n}\n# Specification: Fix Refund Double-Charge Bug\n\n## 1. Problem\n\nUsers can receive a double refund when the `cancelSubscriptionNow()` call fails after the refund has already been issued. The current implementation issues the refund first (irreversible in Stripe), then attempts cancellation. If cancellation fails, the catch block resets `refundStatus` back to \"eligible\", allowing users to request another refund.\n\n## 2. Solution\n\nReorder the `requestRefund()` method to cancel the subscription first (reversible), then issue the refund (irreversible). Update error handling to track which operations succeeded and set appropriate statuses that prevent re-initiation while enabling manual intervention.\n\n## 3. Acceptance Criteria\n\n- **GIVEN** a user requests a refund, **WHEN** `cancelSubscriptionNow` throws an error, **THEN** no refund is issued and `refundStatus` remains \"requested\" (safe to retry)\n- **GIVEN** a user requests a refund, **WHEN** cancellation succeeds but `issueRefund` throws, **THEN** `refundStatus` is set to \"cancel_completed_refund_failed\" for manual intervention\n- **GIVEN** a user requests a refund, **WHEN** both operations succeed but final DB update fails, **THEN** `refundStatus` is set to \"issued\" to prevent double-refund\n- **GIVEN** a user whose `refundStatus` is \"cancel_completed_refund_failed\", **WHEN** they attempt to request another refund, **THEN** the request is rejected\n- **GIVEN** the happy path, **WHEN** all operations succeed, **THEN** existing behavior is preserved\n\n## 4. Files to Modify\n\n| File | Purpose | Action |\n|------|---------|--------|\n| packages/services/src/subscriptions/manager.ts | Reorder operations and fix catch block logic | modify |\n| packages/services/src/subscriptions/__tests__/manager.test.ts | Add failure scenario tests | modify |\n\n## 5. Implementation Tasks\n\n```tasks\n- [ ] T001: Reorder requestRefund() to cancel subscription before issuing refund | File: packages/services/src/subscriptions/manager.ts\n- [ ] T002: Add local boolean tracking for refund-issued state in requestRefund() | File: packages/services/src/subscriptions/manager.ts\n- [ ] T003: Update catch block to differentiate failure scenarios and set appropriate status | File: packages/services/src/subscriptions/manager.ts\n- [ ] T004: Add validation to reject refunds when status is \"cancel_completed_refund_failed\" | File: packages/services/src/subscriptions/manager.ts\n- [ ] T005: Add test for cancelSubscriptionNow failure - refund NOT issued, status stays \"requested\" | File: packages/services/src/subscriptions/__tests__/manager.test.ts\n- [ ] T006: Add test for issueRefund failure after cancel succeeds - status set to partial completion | File: packages/services/src/subscriptions/__tests__/manager.test.ts\n- [ ] T007: Verify existing successful refund flow test still passes | File: packages/services/src/subscriptions/__tests__/manager.test.ts\n- [ ] T008: Run pnpm test to verify all tests pass | File: N/A\n```\n\n## 6. Verification\n\n1. Run `pnpm test` - all tests should pass including new failure scenario tests\n2. Verify that when `cancelSubscriptionNow` fails:\n   - `issueRefund` is never called\n   - `refundStatus` remains \"requested\"\n3. Verify that when `issueRefund` fails after cancel succeeds:\n   - `refundStatus` is set to \"cancel_completed_refund_failed\"\n   - Users cannot request another refund with this status\n4. Verify existing happy path test still passes",
    "generatedAt": "2026-02-07T00:48:25.646Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Reorder requestRefund() to cancel subscription before issuing refund",
        "filePath": "packages/services/src/subscriptions/manager.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Add local boolean tracking for refund-issued state in requestRefund()",
        "filePath": "packages/services/src/subscriptions/manager.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Update catch block to differentiate failure scenarios and set appropriate status",
        "filePath": "packages/services/src/subscriptions/manager.ts",
        "status": "pending"
      },
      {
        "id": "T004",
        "description": "Add validation to reject refunds when status is \"cancel_completed_refund_failed\"",
        "filePath": "packages/services/src/subscriptions/manager.ts",
        "status": "pending"
      },
      {
        "id": "T005",
        "description": "Add test for cancelSubscriptionNow failure - refund NOT issued, status stays \"requested\"",
        "filePath": "packages/services/src/subscriptions/__tests__/manager.test.ts",
        "status": "pending"
      },
      {
        "id": "T006",
        "description": "Add test for issueRefund failure after cancel succeeds - status set to partial completion",
        "filePath": "packages/services/src/subscriptions/__tests__/manager.test.ts",
        "status": "pending"
      },
      {
        "id": "T007",
        "description": "Verify existing successful refund flow test still passes",
        "filePath": "packages/services/src/subscriptions/__tests__/manager.test.ts",
        "status": "pending"
      },
      {
        "id": "T008",
        "description": "Run pnpm test to verify all tests pass",
        "filePath": "N/A",
        "status": "pending"
      }
    ],
    "tasksTotal": 8,
    "tasksCompleted": 8,
    "approvedAt": "2026-02-07T00:48:25.649Z",
    "currentTaskId": "T008"
  },
  "justFinishedAt": "2026-02-07T00:57:36.557Z"
}