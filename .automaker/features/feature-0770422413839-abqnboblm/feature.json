{
  "category": "Uncategorized",
  "description": "TASK 3: Make Database Connection Pool Configurable and Increase Default\nPriority: CRITICAL | Type: Enhancement | Estimated scope: 3 files\n\nContext:\nThe API server's DB pool is hardcoded to max: 10 at apps/api/src/lib/db.ts:12. With 100 concurrent users, this will cause connection exhaustion. The scheduler at apps/scheduler/src/index.ts:47 creates a pool with no max set (defaults to 10 in pg). The AI planner likely has the same issue.\n\nWhat to implement:\n\nIn apps/api/src/lib/config.ts, add a new config field:\n\nDB_POOL_MAX â€” z.coerce.number().int().positive().default(30) â€” default 30 for API\nDB_POOL_IDLE_TIMEOUT_MS â€” z.coerce.number().int().positive().default(20000)\nDB_POOL_CONNECTION_TIMEOUT_MS â€” z.coerce.number().int().positive().default(10000)\nIn apps/api/src/lib/db.ts, use the config values instead of hardcoded numbers:\n\nconst pool = new Pool({\n  connectionString: config.DATABASE_URL,\n  max: config.DB_POOL_MAX,\n  idleTimeoutMillis: config.DB_POOL_IDLE_TIMEOUT_MS,\n  connectionTimeoutMillis: config.DB_POOL_CONNECTION_TIMEOUT_MS,\n});\n\nThe function signature needs to accept these config values (currently it takes config: Env).\n\nIn apps/scheduler/src/index.ts:47, add pool configuration:\n\nAdd DB_POOL_MAX to the scheduler's configSchema (line 23-34) with default 5 (scheduler needs fewer connections)\nPass { connectionString: config.DATABASE_URL, max: config.DB_POOL_MAX } to the Pool constructor\nCheck apps/ai-planner/src/index.ts for the same issue and apply the same fix with default 5.\n\nAdd the new env vars to .env.example with comments.\n\nConventions:\n\nDon't use process.env directly â€” inject via config schema (existing pattern)\nCommit as feat(db): make connection pool size configurable\nRun pnpm build after changes to verify types",
  "title": "Make database connection pool configurable with increased defaults",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-0770422413839-abqnboblm",
  "descriptionHistory": [
    {
      "description": "TASK 3: Make Database Connection Pool Configurable and Increase Default\nPriority: CRITICAL | Type: Enhancement | Estimated scope: 3 files\n\nContext:\nThe API server's DB pool is hardcoded to max: 10 at apps/api/src/lib/db.ts:12. With 100 concurrent users, this will cause connection exhaustion. The scheduler at apps/scheduler/src/index.ts:47 creates a pool with no max set (defaults to 10 in pg). The AI planner likely has the same issue.\n\nWhat to implement:\n\nIn apps/api/src/lib/config.ts, add a new config field:\n\nDB_POOL_MAX â€” z.coerce.number().int().positive().default(30) â€” default 30 for API\nDB_POOL_IDLE_TIMEOUT_MS â€” z.coerce.number().int().positive().default(20000)\nDB_POOL_CONNECTION_TIMEOUT_MS â€” z.coerce.number().int().positive().default(10000)\nIn apps/api/src/lib/db.ts, use the config values instead of hardcoded numbers:\n\nconst pool = new Pool({\n  connectionString: config.DATABASE_URL,\n  max: config.DB_POOL_MAX,\n  idleTimeoutMillis: config.DB_POOL_IDLE_TIMEOUT_MS,\n  connectionTimeoutMillis: config.DB_POOL_CONNECTION_TIMEOUT_MS,\n});\n\nThe function signature needs to accept these config values (currently it takes config: Env).\n\nIn apps/scheduler/src/index.ts:47, add pool configuration:\n\nAdd DB_POOL_MAX to the scheduler's configSchema (line 23-34) with default 5 (scheduler needs fewer connections)\nPass { connectionString: config.DATABASE_URL, max: config.DB_POOL_MAX } to the Pool constructor\nCheck apps/ai-planner/src/index.ts for the same issue and apply the same fix with default 5.\n\nAdd the new env vars to .env.example with comments.\n\nConventions:\n\nDon't use process.env directly â€” inject via config schema (existing pattern)\nCommit as feat(db): make connection pool size configurable\nRun pnpm build after changes to verify types",
      "timestamp": "2026-02-07T00:00:14.130Z",
      "source": "initial"
    }
  ],
  "branchName": "proddd",
  "startedAt": "2026-02-07T00:35:21.473Z",
  "updatedAt": "2026-02-07T00:46:47.975Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/lib/db.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/lib/config.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/scheduler/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/ai-planner/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/.env.example\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"find . -type f -name \\\"*.ts\\\" 2>/dev/null | head -50\",\n  \"description\": \"Find TypeScript files in project\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"ls -la\",\n  \"description\": \"List current directory contents\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Projects/openagent/apps/api/src/lib/db.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Projects/openagent/apps/api/src/lib/config.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Projects/openagent/apps/scheduler/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Projects/openagent/apps/ai-planner/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Projects/openagent/.env.example\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"pwd\",\n  \"description\": \"Get current working directory\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/db.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/config.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/scheduler/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/ai-planner/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/.env.example\"\n}\n# Specification: Make Database Connection Pool Configurable\n\n## 1. Problem\nThe API server's database connection pool is hardcoded to `max: 10`, which will cause connection exhaustion with 100 concurrent users. The scheduler and AI planner workers have no pool configuration (defaulting to 10 in pg), leading to the same issue. Operators have no way to tune pool settings for their workload.\n\n## 2. Solution\nAdd configurable pool settings (`DB_POOL_MAX`, `DB_POOL_IDLE_TIMEOUT_MS`, `DB_POOL_CONNECTION_TIMEOUT_MS`) via the existing Zod config schemas in each app, with appropriate defaults (API: 30, Scheduler/AI-Planner: 5).\n\n## 3. Acceptance Criteria\n- GIVEN an operator deploying the API, WHEN they set `DB_POOL_MAX=50`, THEN the database pool uses max 50 connections\n- GIVEN the API server starts with default config, WHEN no pool env vars are set, THEN the pool uses max=30, idleTimeout=20000ms, connectionTimeout=10000ms\n- GIVEN the scheduler/AI-planner starts with defaults, WHEN no pool env vars are set, THEN each uses max=5 connections\n- GIVEN `.env.example`, WHEN an operator reviews it, THEN they see documented pool configuration options\n\n## 4. Files to Modify\n| File | Purpose | Action |\n|------|---------|--------|\n| apps/api/src/lib/config.ts | Add pool config fields to envSchema | modify |\n| apps/api/src/lib/db.ts | Use config values instead of hardcoded numbers | modify |\n| apps/scheduler/src/index.ts | Add pool config to configSchema and pass to Pool | modify |\n| apps/ai-planner/src/index.ts | Add pool config to configSchema and pass to Pool | modify |\n| .env.example | Document new pool environment variables | modify |\n\n## 5. Implementation Tasks\n```tasks\n- [ ] T001: Add DB_POOL_MAX, DB_POOL_IDLE_TIMEOUT_MS, DB_POOL_CONNECTION_TIMEOUT_MS to envSchema with defaults (30, 20000, 10000) | File: apps/api/src/lib/config.ts\n- [ ] T002: Update createDatabase() to use config pool values instead of hardcoded numbers | File: apps/api/src/lib/db.ts\n- [ ] T003: Add DB_POOL_MAX (default 5) to scheduler configSchema and pass to Pool constructor | File: apps/scheduler/src/index.ts\n- [ ] T004: Add DB_POOL_MAX (default 5) to AI-planner configSchema and pass to Pool constructor | File: apps/ai-planner/src/index.ts\n- [ ] T005: Add pool configuration section with comments to .env.example | File: .env.example\n- [ ] T006: Run pnpm build to verify TypeScript compilation | File: N/A\n```\n\n## 6. Verification\n1. Run `pnpm build` - should pass without type errors\n2. Check that API starts with default pool of 30 connections\n3. Verify scheduler/AI-planner use default pool of 5 connections\n4. Test that setting `DB_POOL_MAX=50` in env changes the API pool size",
    "generatedAt": "2026-02-07T00:36:20.145Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Add DB_POOL_MAX, DB_POOL_IDLE_TIMEOUT_MS, DB_POOL_CONNECTION_TIMEOUT_MS to envSchema with defaults (30, 20000, 10000)",
        "filePath": "apps/api/src/lib/config.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Update createDatabase() to use config pool values instead of hardcoded numbers",
        "filePath": "apps/api/src/lib/db.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Add DB_POOL_MAX (default 5) to scheduler configSchema and pass to Pool constructor",
        "filePath": "apps/scheduler/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T004",
        "description": "Add DB_POOL_MAX (default 5) to AI-planner configSchema and pass to Pool constructor",
        "filePath": "apps/ai-planner/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T005",
        "description": "Add pool configuration section with comments to .env.example",
        "filePath": ".env.example",
        "status": "pending"
      },
      {
        "id": "T006",
        "description": "Run pnpm build to verify TypeScript compilation",
        "filePath": "N/A",
        "status": "pending"
      }
    ],
    "tasksTotal": 6,
    "tasksCompleted": 6,
    "approvedAt": "2026-02-07T00:36:20.152Z",
    "currentTaskId": "T006"
  },
  "justFinishedAt": "2026-02-07T00:46:47.975Z"
}
