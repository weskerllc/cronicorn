{
  "category": "Uncategorized",
  "description": "TASK 16: Add CSRF Protection\nPriority: MEDIUM | Type: Security | Estimated scope: 1-2 files\n\nContext:\nThere is no CSRF token validation on any state-changing endpoint. The app relies on SameSite=lax cookies and CORS origin validation. For 100 users this is acceptable as baseline protection, but explicit CSRF tokens are recommended. Hono has a built-in CSRF middleware.\n\nWhat to implement:\n\nIn apps/api/src/app.ts, add Hono's CSRF middleware:\n\nimport { csrf } from \"hono/csrf\";\n\napp.use(\"*\", csrf({\n  origin: config.WEB_URL,\n}));\n\nAdd this AFTER the CORS middleware (line 73) but BEFORE route handlers.\n\nVerify that:\n\nThe CSRF middleware doesn't break webhook endpoints (/webhooks/stripe receives POST from Stripe, not from the browser). You may need to exclude webhook routes.\nAPI key authenticated requests still work (they don't use cookies/CSRF)\nBetter Auth routes still work (/auth/*)\nTest manually or add a test that:\n\nPOST to a protected endpoint without the origin header â†’ 403\nPOST to a protected endpoint with the correct origin â†’ passes\nKey consideration: Hono's csrf() middleware validates the Origin header matches the allowed origin. This works because browsers always send Origin on cross-origin requests. Requests from the same origin (or non-browser clients like curl) may not send Origin â€” verify this doesn't break API key access.\n\nConventions:\n\nCommit as feat(api): add CSRF protection middleware\nTest that /webhooks/stripe is excluded from CSRF checks",
  "title": "Implement CSRF protection with Hono middleware",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-1770420105637-cxvij2njl",
  "descriptionHistory": [
    {
      "description": "TASK 16: Add CSRF Protection\nPriority: MEDIUM | Type: Security | Estimated scope: 1-2 files\n\nContext:\nThere is no CSRF token validation on any state-changing endpoint. The app relies on SameSite=lax cookies and CORS origin validation. For 100 users this is acceptable as baseline protection, but explicit CSRF tokens are recommended. Hono has a built-in CSRF middleware.\n\nWhat to implement:\n\nIn apps/api/src/app.ts, add Hono's CSRF middleware:\n\nimport { csrf } from \"hono/csrf\";\n\napp.use(\"*\", csrf({\n  origin: config.WEB_URL,\n}));\n\nAdd this AFTER the CORS middleware (line 73) but BEFORE route handlers.\n\nVerify that:\n\nThe CSRF middleware doesn't break webhook endpoints (/webhooks/stripe receives POST from Stripe, not from the browser). You may need to exclude webhook routes.\nAPI key authenticated requests still work (they don't use cookies/CSRF)\nBetter Auth routes still work (/auth/*)\nTest manually or add a test that:\n\nPOST to a protected endpoint without the origin header â†’ 403\nPOST to a protected endpoint with the correct origin â†’ passes\nKey consideration: Hono's csrf() middleware validates the Origin header matches the allowed origin. This works because browsers always send Origin on cross-origin requests. Requests from the same origin (or non-browser clients like curl) may not send Origin â€” verify this doesn't break API key access.\n\nConventions:\n\nCommit as feat(api): add CSRF protection middleware\nTest that /webhooks/stripe is excluded from CSRF checks",
      "timestamp": "2026-02-06T23:21:45.913Z",
      "source": "initial"
    }
  ],
  "branchName": "proddd",
  "startedAt": "2026-02-07T06:02:34.072Z",
  "updatedAt": "2026-02-07T06:07:42.158Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"apps/api/src/**/*.ts\"\n}\n\nðŸ”§ Tool: Grep\nInput: {\n  \"pattern\": \"webhooks\",\n  \"path\": \"apps/api/src\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/routes/webhooks.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/config.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/auth/middleware.ts\"\n}\n\nðŸ”§ Tool: Grep\nInput: {\n  \"pattern\": \"csrf\",\n  \"path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api\"\n}\n\nðŸ”§ Tool: mcp__Context7__resolve-library-id\nInput: {\n  \"query\": \"Hono CSRF middleware protection\",\n  \"libraryName\": \"hono\"\n}\n\nðŸ”§ Tool: mcp__Context7__query-docs\nInput: {\n  \"libraryId\": \"/honojs/website\",\n  \"query\": \"CSRF protection middleware configuration origin validation\"\n}\nNow I have all the information needed to create the specification.\n\n---\n\n# Specification: CSRF Protection Middleware\n\n## 1. Problem\nThe API currently lacks explicit CSRF token validation on state-changing endpoints. While the app has baseline protection via SameSite=lax cookies and CORS origin validation, explicit CSRF protection is a recommended security practice, especially as the user base grows beyond 100 users.\n\n## 2. Solution\nAdd Hono's built-in CSRF middleware to validate the `Origin` header on state-changing requests. The middleware will be configured to allow requests from `config.WEB_URL` while excluding webhook endpoints (which receive POST requests from external services like Stripe) using a custom validation function.\n\n## 3. Acceptance Criteria\n\n- **GIVEN** a browser POST request to a protected endpoint, **WHEN** the request includes a valid Origin header matching WEB_URL, **THEN** the request is allowed to proceed\n- **GIVEN** a browser POST request to a protected endpoint, **WHEN** the request includes an invalid or missing Origin header from a different origin, **THEN** the request is rejected with 403 Forbidden\n- **GIVEN** a POST request to `/webhooks/stripe`, **WHEN** the request comes from Stripe (cross-site), **THEN** the request bypasses CSRF validation and proceeds normally\n- **GIVEN** an API key authenticated request (x-api-key header), **WHEN** the request is made without browser cookies, **THEN** the request proceeds normally (CSRF only applies to cookie-based auth)\n- **GIVEN** a request to Better Auth routes (`/auth/*`), **WHEN** the request is made from the allowed origin, **THEN** the request proceeds normally\n\n## 4. Files to Modify\n\n| File | Purpose | Action |\n|------|---------|--------|\n| `apps/api/src/app.ts` | Main application setup with middleware | modify |\n\n## 5. Implementation Tasks\n\n```tasks\n- [ ] T001: Import csrf middleware from hono/csrf | File: apps/api/src/app.ts\n- [ ] T002: Add CSRF middleware after CORS middleware with custom origin/secFetchSite validation | File: apps/api/src/app.ts\n- [ ] T003: Configure CSRF to exclude webhook routes from validation | File: apps/api/src/app.ts\n```\n\n## 6. Verification\n\n1. **Manual Testing:**\n   - Start the API server: `pnpm dev` in apps/api\n   - Use curl to test CSRF protection:\n     ```bash\n     # Should fail (403) - POST without Origin header from different origin\n     curl -X POST http://localhost:5010/api/jobs -H \"Content-Type: application/json\" -d '{}' -v\n     \n     # Should pass - POST with correct Origin header (if authenticated)\n     curl -X POST http://localhost:5010/api/jobs -H \"Content-Type: application/json\" -H \"Origin: http://localhost:5173\" -d '{}' -v\n     \n     # Should pass - Webhook endpoint (bypasses CSRF)\n     curl -X POST http://localhost:5010/api/webhooks/stripe -H \"Content-Type: application/json\" -H \"stripe-signature: test\" -d '{}' -v\n     ```\n\n2. **Verify in browser:**\n   - Web app should continue to work normally (requests from same origin pass)\n   - API key authenticated requests should continue to work\n\n3. **Type checking:**\n   - Run `pnpm typecheck` to ensure no TypeScript errors\n\n---",
    "generatedAt": "2026-02-07T06:03:26.368Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Import csrf middleware from hono/csrf",
        "filePath": "apps/api/src/app.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Add CSRF middleware after CORS middleware with custom origin/secFetchSite validation",
        "filePath": "apps/api/src/app.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Configure CSRF to exclude webhook routes from validation",
        "filePath": "apps/api/src/app.ts",
        "status": "pending"
      }
    ],
    "tasksTotal": 3,
    "tasksCompleted": 3,
    "approvedAt": "2026-02-07T06:03:26.371Z",
    "currentTaskId": "T003"
  },
  "justFinishedAt": "2026-02-07T06:07:42.158Z"
}
