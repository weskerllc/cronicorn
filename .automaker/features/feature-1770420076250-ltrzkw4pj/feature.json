{
  "category": "Uncategorized",
  "description": "TASK 13: Add Try-Catch Error Handling to Unprotected Route Handlers\nPriority: HIGH | Type: Resilience | Estimated scope: 2-3 files\n\nContext:\nSeveral route handlers lack try-catch blocks. The global error handler at apps/api/src/app.ts:76 (app.onError(errorHandler)) catches unhandled errors, but the error handler at apps/api/src/lib/error-handler.ts only logs and returns a generic 500. Without try-catch in handlers, specific error types (like \"not found\", \"limit reached\") get swallowed into generic 500s.\n\nThe handlers that rely solely on the global error handler (no local try-catch):\n\napps/api/src/routes/dashboard/dashboard.handlers.ts â€” both getDashboardStats and getDashboardActivity\napps/api/src/routes/devices/devices.handlers.ts â€” listConnectedDevices (lines 9-32) â€” the revokeDevice handler already has error handling\nWhat to implement:\n\nCheck apps/api/src/lib/error-handler.ts â€” verify it handles ZodError, business logic errors, and database errors distinctly. If it only does generic 500, enhance it to:\n\nReturn 400 for ZodError (validation failures)\nReturn 404 for \"not found\" errors\nReturn 409 for \"already exists\" or conflict errors\nReturn 500 for everything else with safe error messages (no stack traces)\nVerify the global onError handler is sufficient for the dashboard and device handlers. If the handlers use the withDashboardManager transaction wrapper (they do â€” see dashboard.handlers.ts lines 15 and 33), errors from the manager will bubble up through the transaction and be caught by onError. If this is already working correctly, document it and move on.\n\nIf there are any handlers that bypass the transaction wrapper and call repos directly, add explicit try-catch blocks.\n\nKey files:\n\napps/api/src/lib/error-handler.ts â€” the global handler\napps/api/src/lib/error-utils.ts â€” safe error patterns\napps/api/src/routes/dashboard/dashboard.handlers.ts\napps/api/src/routes/devices/devices.handlers.ts\nConventions:\n\nCommit as fix(api): improve error handling in route handlers\nUse the existing safeErrorMessage() utility from error-utils.ts",
  "title": "Add try-catch error handling to route handlers",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-1770420076250-ltrzkw4pj",
  "descriptionHistory": [
    {
      "description": "TASK 13: Add Try-Catch Error Handling to Unprotected Route Handlers\nPriority: HIGH | Type: Resilience | Estimated scope: 2-3 files\n\nContext:\nSeveral route handlers lack try-catch blocks. The global error handler at apps/api/src/app.ts:76 (app.onError(errorHandler)) catches unhandled errors, but the error handler at apps/api/src/lib/error-handler.ts only logs and returns a generic 500. Without try-catch in handlers, specific error types (like \"not found\", \"limit reached\") get swallowed into generic 500s.\n\nThe handlers that rely solely on the global error handler (no local try-catch):\n\napps/api/src/routes/dashboard/dashboard.handlers.ts â€” both getDashboardStats and getDashboardActivity\napps/api/src/routes/devices/devices.handlers.ts â€” listConnectedDevices (lines 9-32) â€” the revokeDevice handler already has error handling\nWhat to implement:\n\nCheck apps/api/src/lib/error-handler.ts â€” verify it handles ZodError, business logic errors, and database errors distinctly. If it only does generic 500, enhance it to:\n\nReturn 400 for ZodError (validation failures)\nReturn 404 for \"not found\" errors\nReturn 409 for \"already exists\" or conflict errors\nReturn 500 for everything else with safe error messages (no stack traces)\nVerify the global onError handler is sufficient for the dashboard and device handlers. If the handlers use the withDashboardManager transaction wrapper (they do â€” see dashboard.handlers.ts lines 15 and 33), errors from the manager will bubble up through the transaction and be caught by onError. If this is already working correctly, document it and move on.\n\nIf there are any handlers that bypass the transaction wrapper and call repos directly, add explicit try-catch blocks.\n\nKey files:\n\napps/api/src/lib/error-handler.ts â€” the global handler\napps/api/src/lib/error-utils.ts â€” safe error patterns\napps/api/src/routes/dashboard/dashboard.handlers.ts\napps/api/src/routes/devices/devices.handlers.ts\nConventions:\n\nCommit as fix(api): improve error handling in route handlers\nUse the existing safeErrorMessage() utility from error-utils.ts",
      "timestamp": "2026-02-06T23:21:16.593Z",
      "source": "initial"
    }
  ],
  "branchName": "proddd",
  "startedAt": "2026-02-07T05:32:18.738Z",
  "updatedAt": "2026-02-07T05:44:45.807Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/lib/error-handler.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/lib/error-utils.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/routes/dashboard/dashboard.handlers.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/routes/devices/devices.handlers.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/api/src/**/*.ts\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"pwd && ls -la\",\n  \"description\": \"Check current directory\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"find /Users/brandincanfield/Documents/Git/cronicorn/apps -type f -name \\\"*.ts\\\" | head -50\",\n  \"description\": \"Find TypeScript files in apps\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"find /Users/brandincanfield/Documents/Git/cronicorn/apps -type d -name \\\"api\\\" | head -5\",\n  \"description\": \"Find api directories\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/error-handler.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/error-utils.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/routes/dashboard/dashboard.handlers.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/routes/devices/devices.handlers.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Grep\nInput: {\n  \"pattern\": \"already exists|AlreadyExists|conflict\",\n  \"path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src\"\n}\n\nðŸ”§ Tool: Grep\nInput: {\n  \"pattern\": \"throw new Error\",\n  \"path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/domain\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/create-devices-service.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/domain/src/ports/services.ts\"\n}\n\nðŸ”§ Tool: Grep\nInput: {\n  \"pattern\": \"handleErrorResponse|getSafeErrorMessage\",\n  \"path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/routes/jobs/jobs.handlers.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/routes/subscriptions/subscriptions.handlers.ts\"\n}\n\nðŸ”§ Tool: Grep\nInput: {\n  \"pattern\": \"DrizzleError|DatabaseError\",\n  \"path\": \"/Users/brandincanfield/Documents/Git/cronicorn\"\n}\n## Specification: Add Try-Catch Error Handling to Unprotected Route Handlers\n\n---\n\n### 1. Problem\n\nSeveral route handlers (`getDashboardStats`, `getDashboardActivity`, `listConnectedDevices`) lack explicit try-catch blocks, relying solely on the global error handler. While the global handler works, it needs enhancement to properly distinguish error types (ZodError, not found, conflicts) and return appropriate HTTP status codes instead of generic 500s.\n\n---\n\n### 2. Solution\n\nEnhance the global error handler to detect and map additional error types (409 for conflicts, improve \"not found\" detection), then add explicit try-catch blocks to the unprotected handlers (`listConnectedDevices`, `getDashboardStats`, `getDashboardActivity`) using the existing `handleErrorResponse` utility for consistent error handling.\n\n---\n\n### 3. Acceptance Criteria\n\n- **GIVEN** a validation error occurs in any route handler, **WHEN** the error reaches the global handler, **THEN** a 400 status with validation details is returned.\n- **GIVEN** a \"not found\" domain error occurs, **WHEN** the error reaches a handler or global handler, **THEN** a 404 status with \"Resource not found\" message is returned.\n- **GIVEN** a conflict/duplicate error occurs (e.g., \"already exists\"), **WHEN** the error reaches the error handler, **THEN** a 409 status with appropriate message is returned.\n- **GIVEN** an unexpected database or system error occurs, **WHEN** the error bubbles up, **THEN** a 500 status with safe generic message is returned (no stack traces or sensitive info).\n- **GIVEN** the dashboard or devices handlers are called, **WHEN** any error occurs during processing, **THEN** the error is caught locally and processed through `handleErrorResponse`.\n\n---\n\n### 4. Files to Modify\n\n| File | Purpose | Action |\n|------|---------|--------|\n| apps/api/src/lib/error-handler.ts | Global error handler - add 409 conflict detection | modify |\n| apps/api/src/lib/error-utils.ts | Add conflict detection pattern to handleErrorResponse | modify |\n| apps/api/src/routes/dashboard/dashboard.handlers.ts | Add try-catch to getDashboardStats and getDashboardActivity | modify |\n| apps/api/src/routes/devices/devices.handlers.ts | Add try-catch to listConnectedDevices handler | modify |\n\n---\n\n### 5. Implementation Tasks\n\n```tasks\n- [ ] T001: Add conflict/already exists pattern detection to error-handler.ts global handler | File: apps/api/src/lib/error-handler.ts\n- [ ] T002: Add conflict pattern detection to handleErrorResponse utility | File: apps/api/src/lib/error-utils.ts\n- [ ] T003: Add try-catch with handleErrorResponse to getDashboardStats handler | File: apps/api/src/routes/dashboard/dashboard.handlers.ts\n- [ ] T004: Add try-catch with handleErrorResponse to getDashboardActivity handler | File: apps/api/src/routes/dashboard/dashboard.handlers.ts\n- [ ] T005: Add try-catch with handleErrorResponse to listConnectedDevices handler | File: apps/api/src/routes/devices/devices.handlers.ts\n```\n\n---\n\n### 6. Verification\n\n1. **Manual Testing**: Call each handler endpoint with invalid data and verify appropriate error codes (400, 404, 409, 500)\n2. **Unit Tests**: Existing tests should continue to pass; errors from managers should now return proper status codes\n3. **Code Review**: Verify all handlers now have consistent error handling patterns\n4. **Log Verification**: Confirm errors are logged server-side with full context while clients receive safe messages\n\n---",
    "generatedAt": "2026-02-07T05:33:51.299Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Add conflict/already exists pattern detection to error-handler.ts global handler",
        "filePath": "apps/api/src/lib/error-handler.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Add conflict pattern detection to handleErrorResponse utility",
        "filePath": "apps/api/src/lib/error-utils.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Add try-catch with handleErrorResponse to getDashboardStats handler",
        "filePath": "apps/api/src/routes/dashboard/dashboard.handlers.ts",
        "status": "pending"
      },
      {
        "id": "T004",
        "description": "Add try-catch with handleErrorResponse to getDashboardActivity handler",
        "filePath": "apps/api/src/routes/dashboard/dashboard.handlers.ts",
        "status": "pending"
      },
      {
        "id": "T005",
        "description": "Add try-catch with handleErrorResponse to listConnectedDevices handler",
        "filePath": "apps/api/src/routes/devices/devices.handlers.ts",
        "status": "pending"
      }
    ],
    "tasksTotal": 5,
    "tasksCompleted": 5,
    "approvedAt": "2026-02-07T05:33:51.317Z",
    "currentTaskId": "T005"
  },
  "justFinishedAt": "2026-02-07T05:44:45.807Z"
}
