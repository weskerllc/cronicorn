{
  "category": "Uncategorized",
  "description": "TASK 6: Add Basic Observability (Error Tracking + Health Check + Request Logging)\nPriority: CRITICAL | Type: Infrastructure | Estimated scope: 4-5 files\n\nContext:\nCurrently: the health endpoint at apps/api/src/app.ts:167-169 returns { status: \"ok\" } without checking database connectivity. HTTP request logging is only enabled when LOG_LEVEL === \"debug\" (line 58-60). There is no error tracking service (Sentry or equivalent). There are no request correlation IDs. You'll be flying blind with 100 users.\n\nWhat to implement:\n\nFix health check in apps/api/src/app.ts:167-169:\n\nReplace the static response with an actual database ping: SELECT 1\nReturn { status: \"ok\", db: \"connected\", timestamp } on success\nReturn 503 Service Unavailable with { status: \"degraded\", db: \"disconnected\" } on failure\nAdd a timeout (2 seconds) so the health check doesn't hang\nEnable request logging in production in apps/api/src/app.ts:58-60:\n\nRemove the if (config.LOG_LEVEL === \"debug\") guard around honoLogger()\nAlways log requests. Use the Pino logger instead of Hono's default logger so it respects the configured log level and outputs JSON in production.\nAt minimum, log: method, path, status code, duration, userId (if authenticated)\nAdd request correlation IDs:\n\nCreate middleware in apps/api/src/lib/request-id.ts that generates a UUID for each request\nSet it on the Hono context and include it in all log messages\nReturn it in the X-Request-Id response header\nAdd uncaught exception handlers to all 3 apps:\n\napps/api/src/index.ts â€” add process.on(\"uncaughtException\", ...) and process.on(\"unhandledRejection\", ...) that log the error and exit with code 1\napps/scheduler/src/index.ts â€” same (the scheduler already has good error handling in the tick loop, but uncaughtException is still missing)\napps/ai-planner/src/index.ts â€” same\nDocument Sentry as future work in docs/_RUNNING_TECH_DEBT.md â€” note that error tracking should be added before scaling beyond 100 users.\n\nConventions:\n\nUse the existing Pino logger (apps/api/src/lib/logger.ts) â€” never console.log\nCommit as feat(api): add health check, request logging, and correlation IDs\nFollow kebab-case file naming",
  "title": "Implement observability with health checks and request logging",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-1770419983848-rh7axdz53",
  "descriptionHistory": [
    {
      "description": "TASK 6: Add Basic Observability (Error Tracking + Health Check + Request Logging)\nPriority: CRITICAL | Type: Infrastructure | Estimated scope: 4-5 files\n\nContext:\nCurrently: the health endpoint at apps/api/src/app.ts:167-169 returns { status: \"ok\" } without checking database connectivity. HTTP request logging is only enabled when LOG_LEVEL === \"debug\" (line 58-60). There is no error tracking service (Sentry or equivalent). There are no request correlation IDs. You'll be flying blind with 100 users.\n\nWhat to implement:\n\nFix health check in apps/api/src/app.ts:167-169:\n\nReplace the static response with an actual database ping: SELECT 1\nReturn { status: \"ok\", db: \"connected\", timestamp } on success\nReturn 503 Service Unavailable with { status: \"degraded\", db: \"disconnected\" } on failure\nAdd a timeout (2 seconds) so the health check doesn't hang\nEnable request logging in production in apps/api/src/app.ts:58-60:\n\nRemove the if (config.LOG_LEVEL === \"debug\") guard around honoLogger()\nAlways log requests. Use the Pino logger instead of Hono's default logger so it respects the configured log level and outputs JSON in production.\nAt minimum, log: method, path, status code, duration, userId (if authenticated)\nAdd request correlation IDs:\n\nCreate middleware in apps/api/src/lib/request-id.ts that generates a UUID for each request\nSet it on the Hono context and include it in all log messages\nReturn it in the X-Request-Id response header\nAdd uncaught exception handlers to all 3 apps:\n\napps/api/src/index.ts â€” add process.on(\"uncaughtException\", ...) and process.on(\"unhandledRejection\", ...) that log the error and exit with code 1\napps/scheduler/src/index.ts â€” same (the scheduler already has good error handling in the tick loop, but uncaughtException is still missing)\napps/ai-planner/src/index.ts â€” same\nDocument Sentry as future work in docs/_RUNNING_TECH_DEBT.md â€” note that error tracking should be added before scaling beyond 100 users.\n\nConventions:\n\nUse the existing Pino logger (apps/api/src/lib/logger.ts) â€” never console.log\nCommit as feat(api): add health check, request logging, and correlation IDs\nFollow kebab-case file naming",
      "timestamp": "2026-02-06T23:19:44.126Z",
      "source": "initial"
    }
  ],
  "branchName": "proddd",
  "startedAt": "2026-02-07T01:20:34.745Z",
  "updatedAt": "2026-02-07T01:34:47.716Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/lib/logger.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/scheduler/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/ai-planner/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/docs/_RUNNING_TECH_DEBT.md\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/apps/**/*.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/src/**/*.ts\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"pwd && ls -la\",\n  \"description\": \"Check current directory\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/logger.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/scheduler/**/*.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/ai-planner/**/*.ts\"\n}\n\nðŸ”§ Tool: Bash\nInput: {\n  \"command\": \"ls -la /Users/brandincanfield/Documents/Git/cronicorn/docs/\",\n  \"description\": \"List docs directory\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/scheduler/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/ai-planner/src/index.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/docs/_RUNNING_TECH_DEBT.md\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/error-handler.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/config.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/db.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"**/apps/api/src/lib/*.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/types.ts\"\n}\n# Specification: TASK 6 - Add Basic Observability (Error Tracking + Health Check + Request Logging)\n\n## 1. Problem\n\nCurrently, the application lacks essential observability features needed for production readiness:\n- Health endpoint returns static `{ status: \"ok\" }` without checking database connectivity\n- HTTP request logging only works when `LOG_LEVEL === \"debug\"`, making production debugging difficult\n- No request correlation IDs to trace requests across logs\n- No uncaught exception handlers in the 3 worker apps (api, scheduler, ai-planner), risking silent failures\n- No error tracking service documented as future work\n\n## 2. Solution\n\nImplement comprehensive observability by: (1) enhancing the health endpoint to ping the database with a 2s timeout, (2) enabling always-on structured request logging via Pino, (3) adding request ID middleware that generates UUIDs and includes them in logs/headers, (4) adding uncaughtException/unhandledRejection handlers to all 3 apps, and (5) documenting Sentry as future work.\n\n## 3. Acceptance Criteria\n\n- GIVEN a running API with database connected, WHEN `GET /api/health` is called, THEN response includes `{ status: \"ok\", db: \"connected\", timestamp: \"...\" }` with 200 status\n- GIVEN a database failure or timeout (>2s), WHEN `GET /api/health` is called, THEN response includes `{ status: \"degraded\", db: \"disconnected\" }` with 503 status\n- GIVEN any HTTP request, WHEN the request completes, THEN a structured log entry is written with method, path, status, duration, requestId, and userId (if authenticated)\n- GIVEN any HTTP response, WHEN sent to client, THEN an `X-Request-Id` header is included with the request's UUID\n- GIVEN an uncaught exception in any of the 3 apps, WHEN it occurs, THEN the error is logged with full stack trace and process exits with code 1\n\n## 4. Files to Modify\n\n| File | Purpose | Action |\n|------|---------|--------|\n| `apps/api/src/lib/request-id.ts` | Request ID middleware | create |\n| `apps/api/src/lib/request-logger.ts` | Pino-based request logging middleware | create |\n| `apps/api/src/app.ts` | Wire middleware, update health check | modify |\n| `apps/api/src/types.ts` | Add requestId to AppBindings | modify |\n| `apps/api/src/index.ts` | Add uncaught exception handlers | modify |\n| `apps/scheduler/src/index.ts` | Add uncaught exception handlers | modify |\n| `apps/ai-planner/src/index.ts` | Add uncaught exception handlers | modify |\n| `docs/_RUNNING_TECH_DEBT.md` | Document Sentry as future work | modify |\n\n## 5. Implementation Tasks\n\n```tasks\n- [ ] T001: Create request-id middleware that generates UUID, sets context, adds X-Request-Id header | File: apps/api/src/lib/request-id.ts\n- [ ] T002: Create request-logger middleware using Pino with method, path, status, duration, requestId, userId | File: apps/api/src/lib/request-logger.ts\n- [ ] T003: Add requestId to AppBindings Variables type | File: apps/api/src/types.ts\n- [ ] T004: Update app.ts to wire request-id and request-logger middleware (always on) | File: apps/api/src/app.ts\n- [ ] T005: Update health endpoint to ping database with 2s timeout and return proper status | File: apps/api/src/app.ts\n- [ ] T006: Add uncaughtException and unhandledRejection handlers to API index.ts | File: apps/api/src/index.ts\n- [ ] T007: Add uncaughtException and unhandledRejection handlers to scheduler | File: apps/scheduler/src/index.ts\n- [ ] T008: Add uncaughtException and unhandledRejection handlers to ai-planner | File: apps/ai-planner/src/index.ts\n- [ ] T009: Document Sentry as future work in tech debt doc | File: docs/_RUNNING_TECH_DEBT.md\n```\n\n## 6. Verification\n\n1. **Health Check**: \n   - With DB running: `curl http://localhost:3001/api/health` returns 200 with `db: \"connected\"`\n   - With DB stopped: Returns 503 with `db: \"disconnected\"`\n\n2. **Request Logging**: \n   - Make any API request and verify JSON log output includes: method, path, status, duration (ms), requestId\n   - For authenticated requests, verify userId is included\n\n3. **Request ID Header**: \n   - `curl -v http://localhost:3001/api/health` shows `X-Request-Id` header in response\n\n4. **Exception Handlers**: \n   - Throw uncaught exception in each app and verify it logs the error and exits with code 1\n\n---",
    "generatedAt": "2026-02-07T01:22:10.594Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Create request-id middleware that generates UUID, sets context, adds X-Request-Id header",
        "filePath": "apps/api/src/lib/request-id.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Create request-logger middleware using Pino with method, path, status, duration, requestId, userId",
        "filePath": "apps/api/src/lib/request-logger.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Add requestId to AppBindings Variables type",
        "filePath": "apps/api/src/types.ts",
        "status": "pending"
      },
      {
        "id": "T004",
        "description": "Update app.ts to wire request-id and request-logger middleware (always on)",
        "filePath": "apps/api/src/app.ts",
        "status": "pending"
      },
      {
        "id": "T005",
        "description": "Update health endpoint to ping database with 2s timeout and return proper status",
        "filePath": "apps/api/src/app.ts",
        "status": "pending"
      },
      {
        "id": "T006",
        "description": "Add uncaughtException and unhandledRejection handlers to API index.ts",
        "filePath": "apps/api/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T007",
        "description": "Add uncaughtException and unhandledRejection handlers to scheduler",
        "filePath": "apps/scheduler/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T008",
        "description": "Add uncaughtException and unhandledRejection handlers to ai-planner",
        "filePath": "apps/ai-planner/src/index.ts",
        "status": "pending"
      },
      {
        "id": "T009",
        "description": "Document Sentry as future work in tech debt doc",
        "filePath": "docs/_RUNNING_TECH_DEBT.md",
        "status": "pending"
      }
    ],
    "tasksTotal": 9,
    "tasksCompleted": 9,
    "approvedAt": "2026-02-07T01:22:10.596Z",
    "currentTaskId": "T009"
  },
  "justFinishedAt": "2026-02-07T01:34:47.716Z"
}