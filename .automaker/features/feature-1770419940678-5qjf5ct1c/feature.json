{
  "category": "Uncategorized",
  "description": "TASK 4: Add Missing Database Indexes\nPriority: CRITICAL | Type: Performance | Estimated scope: 1 migration file\n\nContext:\nThe schema at packages/adapter-drizzle/src/schema.ts is missing indexes on frequently-queried columns. Current indexes exist on jobEndpoints.jobId, jobEndpoints.nextRunAt, and several on runs. But these high-traffic columns have no index:\n\njobs.userId â€” every job listing and authorization check filters by this\njobEndpoints.tenantId â€” used in endpoint authorization checks (endpoint.tenantId !== userId)\nuser.stripeCustomerId â€” looked up on every Stripe webhook\njobEndpoints.archivedAt â€” filtered in every endpoint listing (exclude archived)\nWhat to implement:\n\nAdd indexes to packages/adapter-drizzle/src/schema.ts:\n\nOn jobs table: add userIdIdx: index(\"jobs_user_id_idx\").on(table.userId) in the table's index callback\nOn jobEndpoints table: add tenantIdIdx: index(\"job_endpoints_tenant_id_idx\").on(table.tenantId) (the table already has an index callback at line 104-107, add to it)\nOn user table: add stripeCustomerIdIdx: index(\"user_stripe_customer_id_idx\").on(table.stripeCustomerId) â€” add an index callback to the table definition\nOn jobEndpoints table: add composite tenantIdArchivedIdx: index(\"job_endpoints_tenant_archived_idx\").on(table.tenantId, table.archivedAt) for filtered endpoint listings\nGenerate the migration:\n\npnpm --filter @cronicorn/adapter-drizzle drizzle-kit generate\n\nThis will create a new SQL migration file in packages/adapter-drizzle/migrations/. Verify it contains only CREATE INDEX statements.\n\nRun the migration to verify it applies cleanly:\n\npnpm db:migrate\n\nConventions:\n\nCommit as perf(db): add missing indexes for user and tenant queries\nRun pnpm build:packages after schema changes\nThe migration tool is drizzle-kit â€” check packages/adapter-drizzle/package.json for the exact script name",
  "title": "Add missing database indexes for performance",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-1770419940678-5qjf5ct1c",
  "descriptionHistory": [
    {
      "description": "TASK 4: Add Missing Database Indexes\nPriority: CRITICAL | Type: Performance | Estimated scope: 1 migration file\n\nContext:\nThe schema at packages/adapter-drizzle/src/schema.ts is missing indexes on frequently-queried columns. Current indexes exist on jobEndpoints.jobId, jobEndpoints.nextRunAt, and several on runs. But these high-traffic columns have no index:\n\njobs.userId â€” every job listing and authorization check filters by this\njobEndpoints.tenantId â€” used in endpoint authorization checks (endpoint.tenantId !== userId)\nuser.stripeCustomerId â€” looked up on every Stripe webhook\njobEndpoints.archivedAt â€” filtered in every endpoint listing (exclude archived)\nWhat to implement:\n\nAdd indexes to packages/adapter-drizzle/src/schema.ts:\n\nOn jobs table: add userIdIdx: index(\"jobs_user_id_idx\").on(table.userId) in the table's index callback\nOn jobEndpoints table: add tenantIdIdx: index(\"job_endpoints_tenant_id_idx\").on(table.tenantId) (the table already has an index callback at line 104-107, add to it)\nOn user table: add stripeCustomerIdIdx: index(\"user_stripe_customer_id_idx\").on(table.stripeCustomerId) â€” add an index callback to the table definition\nOn jobEndpoints table: add composite tenantIdArchivedIdx: index(\"job_endpoints_tenant_archived_idx\").on(table.tenantId, table.archivedAt) for filtered endpoint listings\nGenerate the migration:\n\npnpm --filter @cronicorn/adapter-drizzle drizzle-kit generate\n\nThis will create a new SQL migration file in packages/adapter-drizzle/migrations/. Verify it contains only CREATE INDEX statements.\n\nRun the migration to verify it applies cleanly:\n\npnpm db:migrate\n\nConventions:\n\nCommit as perf(db): add missing indexes for user and tenant queries\nRun pnpm build:packages after schema changes\nThe migration tool is drizzle-kit â€” check packages/adapter-drizzle/package.json for the exact script name",
      "timestamp": "2026-02-06T23:19:00.910Z",
      "source": "initial"
    }
  ],
  "branchName": "proddd",
  "startedAt": "2026-02-07T00:58:21.877Z",
  "updatedAt": "2026-02-07T01:03:20.966Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/jspahrsern/code/cronicorn/packages/adapter-drizzle/src/schema.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/jspahrsern/code/cronicorn/packages/adapter-drizzle/package.json\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"packages/adapter-drizzle/migrations/**/*.sql\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/adapter-drizzle/src/schema.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/packages/adapter-drizzle/package.json\"\n}\n# Specification: Add Missing Database Indexes\n\n## 1. Problem\nDatabase queries for frequently-accessed columns (jobs.userId, jobEndpoints.tenantId, user.stripeCustomerId, jobEndpoints.archivedAt) lack indexes, causing slow query performance for job listings, authorization checks, Stripe webhook processing, and endpoint filtering operations.\n\n## 2. Solution\nAdd four database indexes to the Drizzle schema: userIdIdx on jobs table, tenantIdIdx and composite tenantIdArchivedIdx on jobEndpoints table, and stripeCustomerIdIdx on user table. Then generate and verify the migration.\n\n## 3. Acceptance Criteria\n- GIVEN the jobs table, WHEN queried by userId, THEN an index exists to optimize the lookup\n- GIVEN the jobEndpoints table, WHEN queried by tenantId or filtered by tenantId+archivedAt, THEN indexes exist to optimize these queries\n- GIVEN the user table, WHEN queried by stripeCustomerId (Stripe webhooks), THEN an index exists to optimize the lookup\n- GIVEN the schema changes, WHEN running `pnpm --filter @cronicorn/adapter-drizzle generate`, THEN a migration file containing only CREATE INDEX statements is generated\n- GIVEN the generated migration, WHEN running `pnpm db:migrate`, THEN the migration applies successfully\n\n## 4. Files to Modify\n| File | Purpose | Action |\n|------|---------|--------|\n| packages/adapter-drizzle/src/schema.ts | Add index definitions to user, jobs, and jobEndpoints tables | modify |\n| packages/adapter-drizzle/migrations/0021_*.sql | Generated migration with CREATE INDEX statements | create (auto-generated) |\n\n## 5. Implementation Tasks\n```tasks\n- [ ] T001: Add stripeCustomerIdIdx to user table definition | File: packages/adapter-drizzle/src/schema.ts\n- [ ] T002: Add userIdIdx to jobs table definition | File: packages/adapter-drizzle/src/schema.ts\n- [ ] T003: Add tenantIdIdx and tenantIdArchivedIdx to jobEndpoints table | File: packages/adapter-drizzle/src/schema.ts\n- [ ] T004: Generate migration using drizzle-kit | File: packages/adapter-drizzle/migrations/\n- [ ] T005: Verify migration contains only CREATE INDEX statements | File: packages/adapter-drizzle/migrations/\n- [ ] T006: Run pnpm build:packages to verify schema compiles | File: N/A\n```\n\n## 6. Verification\n1. Inspect the generated migration file to confirm it contains only CREATE INDEX statements for the four new indexes\n2. Run `pnpm db:migrate` and verify it completes without errors\n3. Run `pnpm build:packages` to verify schema compiles correctly",
    "generatedAt": "2026-02-07T00:59:05.335Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Add stripeCustomerIdIdx to user table definition",
        "filePath": "packages/adapter-drizzle/src/schema.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Add userIdIdx to jobs table definition",
        "filePath": "packages/adapter-drizzle/src/schema.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Add tenantIdIdx and tenantIdArchivedIdx to jobEndpoints table",
        "filePath": "packages/adapter-drizzle/src/schema.ts",
        "status": "pending"
      },
      {
        "id": "T004",
        "description": "Generate migration using drizzle-kit",
        "filePath": "packages/adapter-drizzle/migrations/",
        "status": "pending"
      },
      {
        "id": "T005",
        "description": "Verify migration contains only CREATE INDEX statements",
        "filePath": "packages/adapter-drizzle/migrations/",
        "status": "pending"
      },
      {
        "id": "T006",
        "description": "Run pnpm build:packages to verify schema compiles",
        "filePath": "N/A",
        "status": "pending"
      }
    ],
    "tasksTotal": 6,
    "tasksCompleted": 6,
    "approvedAt": "2026-02-07T00:59:05.339Z",
    "currentTaskId": "T006"
  },
  "justFinishedAt": "2026-02-07T01:03:20.966Z"
}
