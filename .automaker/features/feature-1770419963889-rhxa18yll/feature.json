{
  "category": "Uncategorized",
  "description": "TASK 5: Add Per-User Rate Limiting to API\nPriority: CRITICAL | Type: Security | Estimated scope: 2-3 files\n\nContext:\nAPI key endpoints have 100 req/min rate limiting (via Better Auth plugin at apps/api/src/auth/config.ts:115-118), but all session-authenticated endpoints have zero rate limiting. A single authenticated user can spam job creation, list runs indefinitely, or exhaust database connections. There's also no brute-force protection on login.\n\nWhat to implement:\n\nAdd a rate limiting middleware to apps/api/src/app.ts. Hono doesn't have a built-in rate limiter, so use an in-memory approach (acceptable for single-instance deployment at 100 users):\n\nCreate apps/api/src/lib/rate-limiter.ts â€” a simple sliding-window rate limiter keyed by userId\nDefault: 60 requests per minute per user for mutation endpoints (POST/PATCH/DELETE)\nDefault: 120 requests per minute per user for read endpoints (GET)\nReturn 429 Too Many Requests with Retry-After header when exceeded\nApply the middleware in apps/api/src/app.ts after auth middleware but before route handlers:\n\nApply to /jobs/*, /endpoints/*, /runs/*, /subscriptions/*, /dashboard/*, /devices/*\nDo NOT apply to /health, /auth/*, or /webhooks/*\nAdd configuration to apps/api/src/lib/config.ts:\n\nRATE_LIMIT_MUTATION_RPM â€” default 60\nRATE_LIMIT_READ_RPM â€” default 120\nAdd basic tests verifying the rate limiter returns 429 after exceeding the limit.\n\nNote: For 100 users, in-memory rate limiting is fine. Document in docs/_RUNNING_TECH_DEBT.md that this needs to move to Redis for multi-instance deployment.\n\nConventions:\n\nCommit as feat(api): add per-user rate limiting middleware\nNo external dependencies â€” use a simple Map-based implementation\nFile naming: kebab-case\nAdd tech debt entry about Redis migration",
  "title": "Implement per-user rate limiting on authenticated API endpoints",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "waiting_approval",
  "id": "feature-1770419963889-rhxa18yll",
  "descriptionHistory": [
    {
      "description": "TASK 5: Add Per-User Rate Limiting to API\nPriority: CRITICAL | Type: Security | Estimated scope: 2-3 files\n\nContext:\nAPI key endpoints have 100 req/min rate limiting (via Better Auth plugin at apps/api/src/auth/config.ts:115-118), but all session-authenticated endpoints have zero rate limiting. A single authenticated user can spam job creation, list runs indefinitely, or exhaust database connections. There's also no brute-force protection on login.\n\nWhat to implement:\n\nAdd a rate limiting middleware to apps/api/src/app.ts. Hono doesn't have a built-in rate limiter, so use an in-memory approach (acceptable for single-instance deployment at 100 users):\n\nCreate apps/api/src/lib/rate-limiter.ts â€” a simple sliding-window rate limiter keyed by userId\nDefault: 60 requests per minute per user for mutation endpoints (POST/PATCH/DELETE)\nDefault: 120 requests per minute per user for read endpoints (GET)\nReturn 429 Too Many Requests with Retry-After header when exceeded\nApply the middleware in apps/api/src/app.ts after auth middleware but before route handlers:\n\nApply to /jobs/*, /endpoints/*, /runs/*, /subscriptions/*, /dashboard/*, /devices/*\nDo NOT apply to /health, /auth/*, or /webhooks/*\nAdd configuration to apps/api/src/lib/config.ts:\n\nRATE_LIMIT_MUTATION_RPM â€” default 60\nRATE_LIMIT_READ_RPM â€” default 120\nAdd basic tests verifying the rate limiter returns 429 after exceeding the limit.\n\nNote: For 100 users, in-memory rate limiting is fine. Document in docs/_RUNNING_TECH_DEBT.md that this needs to move to Redis for multi-instance deployment.\n\nConventions:\n\nCommit as feat(api): add per-user rate limiting middleware\nNo external dependencies â€” use a simple Map-based implementation\nFile naming: kebab-case\nAdd tech debt entry about Redis migration",
      "timestamp": "2026-02-06T23:19:24.200Z",
      "source": "initial"
    }
  ],
  "branchName": "proddd",
  "startedAt": "2026-02-07T01:04:07.009Z",
  "updatedAt": "2026-02-07T01:19:39.078Z",
  "planSpec": {
    "status": "approved",
    "version": 1,
    "reviewedByUser": false,
    "content": "ðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/lib/config.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/apps/api/src/auth/config.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"apps/api/src/**/*.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/app.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/config.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/auth/config.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/auth/middleware.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"docs/_RUNNING_TECH_DEBT.md\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/docs/_RUNNING_TECH_DEBT.md\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/types.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/error-handler.ts\"\n}\n\nðŸ”§ Tool: Glob\nInput: {\n  \"pattern\": \"apps/api/src/**/__tests__/*.test.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/routes/jobs/__tests__/jobs.api.test.ts\"\n}\n\nðŸ”§ Tool: Read\nInput: {\n  \"file_path\": \"/Users/brandincanfield/Documents/Git/cronicorn/apps/api/src/lib/__tests__/test-helpers.ts\"\n}\n## Specification: Per-User Rate Limiting for API\n\n---\n\n### 1. **Problem**\n\nAuthenticated session-based API endpoints (jobs, runs, endpoints, subscriptions, dashboard, devices) have no rate limiting, allowing a single user to spam requests, exhaust database connections, or abuse the service. While API keys have rate limiting via Better Auth plugin (100 req/min), session-authenticated users are unprotected.\n\n---\n\n### 2. **Solution**\n\nImplement a sliding-window in-memory rate limiter middleware keyed by `userId`, applied after auth middleware. Different limits for mutations (60 rpm) vs reads (120 rpm). Returns `429 Too Many Requests` with `Retry-After` header when exceeded. Document Redis migration for future multi-instance deployment.\n\n---\n\n### 3. **Acceptance Criteria**\n\n- GIVEN an authenticated user making POST/PATCH/DELETE requests, WHEN they exceed 60 requests in 1 minute, THEN they receive a 429 response with Retry-After header\n- GIVEN an authenticated user making GET requests, WHEN they exceed 120 requests in 1 minute, THEN they receive a 429 response with Retry-After header  \n- GIVEN requests to `/health`, `/auth/*`, or `/webhooks/*`, WHEN any number of requests are made, THEN no rate limiting is applied\n- GIVEN rate limit configuration in environment, WHEN the API starts, THEN it uses the configured limits (RATE_LIMIT_MUTATION_RPM, RATE_LIMIT_READ_RPM)\n- GIVEN rate limiting implementation, WHEN deployed to multi-instance, THEN tech debt documentation exists for Redis migration\n\n---\n\n### 4. **Files to Modify**\n\n| File | Purpose | Action |\n|------|---------|--------|\n| `apps/api/src/lib/rate-limiter.ts` | Sliding-window rate limiter implementation | create |\n| `apps/api/src/lib/config.ts` | Add rate limit configuration env vars | modify |\n| `apps/api/src/app.ts` | Apply rate limit middleware after auth middleware | modify |\n| `apps/api/src/lib/__tests__/rate-limiter.test.ts` | Unit tests for rate limiter | create |\n| `docs/_RUNNING_TECH_DEBT.md` | Document Redis migration need | modify |\n\n---\n\n### 5. **Implementation Tasks**\n\n```tasks\n- [ ] T001: Add RATE_LIMIT_MUTATION_RPM and RATE_LIMIT_READ_RPM to config schema | File: apps/api/src/lib/config.ts\n- [ ] T002: Create sliding-window rate limiter with Map-based storage | File: apps/api/src/lib/rate-limiter.ts\n- [ ] T003: Create rate limit middleware factory for Hono | File: apps/api/src/lib/rate-limiter.ts\n- [ ] T004: Apply rate limit middleware to protected routes in app.ts | File: apps/api/src/app.ts\n- [ ] T005: Add unit tests for rate limiter returning 429 after limit exceeded | File: apps/api/src/lib/__tests__/rate-limiter.test.ts\n- [ ] T006: Document Redis migration tech debt | File: docs/_RUNNING_TECH_DEBT.md\n```\n\n---\n\n### 6. **Verification**\n\n1. Run unit tests: `pnpm --filter @cronicorn/api test` - rate limiter tests should pass\n2. Manual test: Use curl/httpie to send 61 POST requests to `/api/jobs` in quick succession - 61st should return 429\n3. Verify `/health`, `/auth/*`, `/webhooks/*` are not rate limited\n4. Check 429 response includes `Retry-After` header with seconds until window reset\n5. Verify rate limit config env vars are read correctly\n\n---\n\n\"",
    "generatedAt": "2026-02-07T01:05:10.950Z",
    "tasks": [
      {
        "id": "T001",
        "description": "Add RATE_LIMIT_MUTATION_RPM and RATE_LIMIT_READ_RPM to config schema",
        "filePath": "apps/api/src/lib/config.ts",
        "status": "pending"
      },
      {
        "id": "T002",
        "description": "Create sliding-window rate limiter with Map-based storage",
        "filePath": "apps/api/src/lib/rate-limiter.ts",
        "status": "pending"
      },
      {
        "id": "T003",
        "description": "Create rate limit middleware factory for Hono",
        "filePath": "apps/api/src/lib/rate-limiter.ts",
        "status": "pending"
      },
      {
        "id": "T004",
        "description": "Apply rate limit middleware to protected routes in app.ts",
        "filePath": "apps/api/src/app.ts",
        "status": "pending"
      },
      {
        "id": "T005",
        "description": "Add unit tests for rate limiter returning 429 after limit exceeded",
        "filePath": "apps/api/src/lib/__tests__/rate-limiter.test.ts",
        "status": "pending"
      },
      {
        "id": "T006",
        "description": "Document Redis migration tech debt",
        "filePath": "docs/_RUNNING_TECH_DEBT.md",
        "status": "pending"
      }
    ],
    "tasksTotal": 6,
    "tasksCompleted": 6,
    "approvedAt": "2026-02-07T01:05:10.953Z",
    "currentTaskId": "T006"
  },
  "justFinishedAt": "2026-02-07T01:19:39.078Z"
}
