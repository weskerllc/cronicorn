{
  "category": "Uncategorized",
  "description": "TASK 8: Add Subscription API Integration Tests\nPriority: HIGH | Type: Test coverage | Estimated scope: 1-2 new test files\n\nContext:\nAll 5 subscription endpoints have zero API-level tests. The handlers are at apps/api/src/routes/subscriptions/subscriptions.handlers.ts. The service-layer manager has unit tests (packages/services/src/subscriptions/__tests__/manager.test.ts), but no tests verify the request/response mapping, error formatting, or auth middleware integration at the API layer.\n\nWhat to implement:\n\nCreate apps/api/src/routes/subscriptions/__tests__/subscriptions.api.test.ts.\n\nFollow the same pattern as apps/api/src/routes/jobs/__tests__/jobs.api.test.ts:\n\nUse test.extend() with transactional fixture\nCreate test user with createTestUser(tx, { id: mockUserId })\nCreate mock auth with createMockAuth(createMockSession(mockUserId))\nCreate app with createApp(tx, testConfig, mockAuth, { useTransactions: false })\nTests needed:\n\nGET /api/subscriptions/status:\n\nReturns current tier, subscription status, refund eligibility for free user\nReturns pro tier details for user with tier: \"pro\", subscriptionStatus: \"active\"\nReturns refund-eligible status when within 14-day window\nRequires authentication (401 without session)\nPOST /api/subscriptions/checkout:\n\nMock the Stripe payment provider to return a checkout URL\nVerify it calls createCheckout with correct userId and plan\nReturns the checkout URL in response\nRejects invalid plan values (400)\nPOST /api/subscriptions/portal:\n\nMock Stripe to return portal URL\nReturns 400 if user has no Stripe subscription\nPOST /api/subscriptions/refund:\n\nReturns 400 with clear message for non-pro user\nReturns 400 for user with expired refund window\nReturns 400 for user who already got refund (refundStatus: \"issued\")\nReturns 400 for user with no payment intent\nVerify successful refund flow returns 200 (mock Stripe provider)\nGET /api/subscriptions/usage:\n\nReturns endpoint count and tier limits for free user\nReturns correct limits for pro user\nFor mocking the Stripe payment provider: the createApp function at apps/api/src/app.ts:47-52 creates a StripePaymentProvider. You'll need to either:\n\nPass a mock payment provider (check if createApp supports DI for this, or modify it to accept one)\nOr mock at the module level\nKey files to read first:\n\napps/api/src/routes/subscriptions/subscriptions.handlers.ts — the handlers being tested\napps/api/src/routes/subscriptions/subscriptions.routes.ts — route definitions with schemas\napps/api/src/routes/jobs/__tests__/jobs.api.test.ts — the pattern to follow\npackages/services/src/subscriptions/__tests__/manager.test.ts — understand mock patterns\nConventions:\n\nCommit as test(subscriptions): add API integration tests for all subscription endpoints\nRun pnpm test after",
  "title": "Add subscription API integration tests",
  "images": [],
  "imagePaths": [],
  "textFilePaths": [],
  "skipTests": true,
  "model": "opus",
  "thinkingLevel": "none",
  "reasoningEffort": "none",
  "priority": 2,
  "planningMode": "spec",
  "requirePlanApproval": false,
  "dependencies": [],
  "workMode": "current",
  "titleGenerating": false,
  "status": "backlog",
  "id": "feature-1770420005087-u4ipipewo",
  "descriptionHistory": [
    {
      "description": "TASK 8: Add Subscription API Integration Tests\nPriority: HIGH | Type: Test coverage | Estimated scope: 1-2 new test files\n\nContext:\nAll 5 subscription endpoints have zero API-level tests. The handlers are at apps/api/src/routes/subscriptions/subscriptions.handlers.ts. The service-layer manager has unit tests (packages/services/src/subscriptions/__tests__/manager.test.ts), but no tests verify the request/response mapping, error formatting, or auth middleware integration at the API layer.\n\nWhat to implement:\n\nCreate apps/api/src/routes/subscriptions/__tests__/subscriptions.api.test.ts.\n\nFollow the same pattern as apps/api/src/routes/jobs/__tests__/jobs.api.test.ts:\n\nUse test.extend() with transactional fixture\nCreate test user with createTestUser(tx, { id: mockUserId })\nCreate mock auth with createMockAuth(createMockSession(mockUserId))\nCreate app with createApp(tx, testConfig, mockAuth, { useTransactions: false })\nTests needed:\n\nGET /api/subscriptions/status:\n\nReturns current tier, subscription status, refund eligibility for free user\nReturns pro tier details for user with tier: \"pro\", subscriptionStatus: \"active\"\nReturns refund-eligible status when within 14-day window\nRequires authentication (401 without session)\nPOST /api/subscriptions/checkout:\n\nMock the Stripe payment provider to return a checkout URL\nVerify it calls createCheckout with correct userId and plan\nReturns the checkout URL in response\nRejects invalid plan values (400)\nPOST /api/subscriptions/portal:\n\nMock Stripe to return portal URL\nReturns 400 if user has no Stripe subscription\nPOST /api/subscriptions/refund:\n\nReturns 400 with clear message for non-pro user\nReturns 400 for user with expired refund window\nReturns 400 for user who already got refund (refundStatus: \"issued\")\nReturns 400 for user with no payment intent\nVerify successful refund flow returns 200 (mock Stripe provider)\nGET /api/subscriptions/usage:\n\nReturns endpoint count and tier limits for free user\nReturns correct limits for pro user\nFor mocking the Stripe payment provider: the createApp function at apps/api/src/app.ts:47-52 creates a StripePaymentProvider. You'll need to either:\n\nPass a mock payment provider (check if createApp supports DI for this, or modify it to accept one)\nOr mock at the module level\nKey files to read first:\n\napps/api/src/routes/subscriptions/subscriptions.handlers.ts — the handlers being tested\napps/api/src/routes/subscriptions/subscriptions.routes.ts — route definitions with schemas\napps/api/src/routes/jobs/__tests__/jobs.api.test.ts — the pattern to follow\npackages/services/src/subscriptions/__tests__/manager.test.ts — understand mock patterns\nConventions:\n\nCommit as test(subscriptions): add API integration tests for all subscription endpoints\nRun pnpm test after",
      "timestamp": "2026-02-06T23:20:05.373Z",
      "source": "initial"
    }
  ]
}