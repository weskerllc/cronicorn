name: Publish MCP Server to npm

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version_bump:
        description: Version bump type
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      npm_tag:
        description: "npm dist-tag (e.g., latest, beta)"
        required: false
        default: latest
        type: string

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.17.1
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Build api-contracts (dependency)
        run: pnpm --filter @cronicorn/api-contracts build

      - name: Determine version
        id: version
        working-directory: apps/mcp-server
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            # Extract version from release tag (e.g., v1.2.3 -> 1.2.3 or mcp-server-v1.2.3 -> 1.2.3)
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            NEW_VERSION=$(echo "$RELEASE_TAG" | sed -E 's/^(mcp-server-)?v//')
            echo "ðŸ“¦ Using version from release tag: $NEW_VERSION"

            # Update package.json to match release version
            npm version "$NEW_VERSION" --no-git-tag-version --allow-same-version
          else
            # Manual workflow_dispatch: bump version
            npm version ${{ inputs.version_bump }} --no-git-tag-version
            NEW_VERSION=$(node -p "require('./package.json').version")
            echo "ðŸ“¦ Bumped version to: $NEW_VERSION"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Build MCP server bundle
        run: pnpm --filter @cronicorn/mcp-server build

      - name: Verify bundle
        working-directory: apps/mcp-server
        run: |
          echo "ðŸ” Verifying bundle contents..."
          pnpm pack --dry-run

          echo "ðŸ“Š Bundle size:"
          ls -lh dist/index.js

          echo "âœ… Verifying shebang:"
          head -1 dist/index.js

          echo "âœ… Verifying no workspace references:"
          ! grep -q "@cronicorn/api-contracts" dist/index.js || (echo "âŒ Found workspace reference in bundle" && exit 1)

          echo "âœ… Verifying api-contracts code is bundled:"
          grep -q "CreateJobRequestSchema" dist/index.js || (echo "âŒ api-contracts not bundled" && exit 1)

          echo "âœ… Bundle verification passed!"

      - name: Publish to npm
        working-directory: apps/mcp-server
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Determine npm tag based on trigger
          if [ "${{ github.event_name }}" = "release" ]; then
            # Check if release is a prerelease
            if [ "${{ github.event.release.prerelease }}" = "true" ]; then
              NPM_TAG="beta"
            else
              NPM_TAG="latest"
            fi
          else
            NPM_TAG="${{ inputs.npm_tag }}"
          fi

          echo "ðŸ“¤ Publishing @cronicorn/mcp-server@${{ steps.version.outputs.new_version }} to npm with tag: $NPM_TAG"
          npm publish --access public --tag "$NPM_TAG" --provenance
          echo "âœ… Published successfully!"

      - name: Commit version bump
        if: github.event_name == 'workflow_dispatch'
        run: |
          git add apps/mcp-server/package.json
          git commit -m "chore(mcp-server): release v${{ steps.version.outputs.new_version }} [skip ci]"
          git tag "mcp-server-v${{ steps.version.outputs.new_version }}"

      - name: Push changes
        if: github.event_name == 'workflow_dispatch'
        run: |
          git push origin main
          git push origin "mcp-server-v${{ steps.version.outputs.new_version }}"

      - name: Create GitHub Release
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.version.outputs.new_version }}';
            const tag = `mcp-server-v${version}`;

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `MCP Server v${version}`,
              body: `## MCP Server v${version}

            Published to npm: https://www.npmjs.com/package/@cronicorn/mcp-server/v/${version}

            ### Installation

            \`\`\`bash
            npm install -g @cronicorn/mcp-server@${version}
            # or
            pnpm add -g @cronicorn/mcp-server@${version}
            \`\`\`

            ### Usage

            See [README](https://github.com/weskerllc/cronicorn/tree/main/apps/mcp-server/README.md) for configuration and usage instructions.

            ---

            **npm package:** [@cronicorn/mcp-server](https://www.npmjs.com/package/@cronicorn/mcp-server)
            **npm tag:** \`${inputs.npm_tag || 'latest'}\`
            **Bundle size:** ~470KB
            **Node version:** >=20.0.0`,
              draft: false,
              prerelease: inputs.npm_tag !== 'latest'
            });

            console.log(`âœ… Created GitHub release: ${release.data.html_url}`);

      - name: Summary
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            NPM_TAG="${{ github.event.release.prerelease == 'true' && 'beta' || 'latest' }}"
            TRIGGER="GitHub Release: ${{ github.event.release.tag_name }}"
          else
            NPM_TAG="${{ inputs.npm_tag }}"
            TRIGGER="Manual workflow_dispatch"
          fi

          echo "## ðŸŽ‰ MCP Server Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** $TRIGGER" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**npm tag:** \`$NPM_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** [@cronicorn/mcp-server](https://www.npmjs.com/package/@cronicorn/mcp-server/v/${{ steps.version.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "npm install -g @cronicorn/mcp-server@${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
