name: Deploy to Dokploy

on:
  # Automatic deployment to staging on new releases
  release:
    types: [published]

  # Manual deployment to production or staging
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to deploy to
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: "Version to deploy (e.g., 1.6.1 or latest)"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event_name == 'release' && 'staging' || github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Determine deployment version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            # Auto-deploy to staging with latest tag
            echo "version=latest" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            # Manual deployment
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Dokploy via API
        env:
          DOKPLOY_URL: ${{ secrets.DOKPLOY_URL }}
          DOKPLOY_TOKEN: ${{ secrets.DOKPLOY_TOKEN }}
          DOKPLOY_COMPOSE_ID: ${{ steps.version.outputs.environment == 'staging' && secrets.DOKPLOY_STAGING_COMPOSE_ID || secrets.DOKPLOY_PRODUCTION_COMPOSE_ID }}
          DEPLOY_VERSION: ${{ steps.version.outputs.version }}
          DEPLOY_ENVIRONMENT: ${{ steps.version.outputs.environment }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ Deploying Cronicorn to $DEPLOY_ENVIRONMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Target version: $DEPLOY_VERSION"
          echo "Compose ID: $DOKPLOY_COMPOSE_ID"
          echo ""

          # Normalize URL (remove trailing slash)
          DOKPLOY_URL="${DOKPLOY_URL%/}"

          # Step 1: Fetch current configuration
          echo "ðŸ“¥ Step 1/4: Fetching current configuration..."
          COMPOSE_DATA=$(curl -s -X GET \
            "$DOKPLOY_URL/api/compose.one?composeId=$DOKPLOY_COMPOSE_ID" \
            -H "x-api-key: $DOKPLOY_TOKEN")

          if [ $? -ne 0 ]; then
            echo "âŒ Failed to fetch compose configuration"
            exit 1
          fi

          # Check if we got valid JSON
          if ! echo "$COMPOSE_DATA" | jq -e . >/dev/null 2>&1; then
            echo "âŒ Invalid response from API"
            echo "Response: $COMPOSE_DATA"
            exit 1
          fi

          echo "âœ… Configuration fetched"
          echo ""

          # Step 2: Extract and update env
          echo "ðŸ“ Step 2/4: Updating IMAGE_TAG..."
          CURRENT_ENV=$(echo "$COMPOSE_DATA" | jq -r '.env // ""')

          # Show current IMAGE_TAG
          CURRENT_TAG=$(echo "$CURRENT_ENV" | grep "^IMAGE_TAG=" | cut -d'=' -f2 | sed 's/ *#.*//')
          echo "   Current: $CURRENT_TAG"
          echo "   New:     $DEPLOY_VERSION"
          echo ""

          # Update IMAGE_TAG
          if echo "$CURRENT_ENV" | grep -q "^IMAGE_TAG="; then
            # Replace existing IMAGE_TAG line (preserving any comments)
            UPDATED_ENV=$(echo "$CURRENT_ENV" | sed "s/^IMAGE_TAG=.*/IMAGE_TAG=$DEPLOY_VERSION  # Use specific version like v1.2.3 for production/")
          else
            # Add IMAGE_TAG if it doesn't exist
            UPDATED_ENV="$CURRENT_ENV"$'\n'"IMAGE_TAG=$DEPLOY_VERSION"
          fi

          echo "âœ… Environment updated"
          echo ""

          # Step 3: Push updated environment to Dokploy
          echo "â¬†ï¸  Step 3/4: Pushing updated environment to Dokploy..."

          UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$DOKPLOY_URL/api/compose.update" \
            -H "x-api-key: $DOKPLOY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$DOKPLOY_COMPOSE_ID" --arg env "$UPDATED_ENV" '{composeId: $id, env: $env}')")

          UPDATE_HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
          UPDATE_BODY=$(echo "$UPDATE_RESPONSE" | sed '$d')

          if [ "$UPDATE_HTTP_CODE" = "200" ]; then
            echo "âœ… Environment updated in Dokploy"
          else
            echo "âŒ Failed to update environment (HTTP $UPDATE_HTTP_CODE)"
            echo "Response: $UPDATE_BODY"
            exit 1
          fi
          echo ""

          # Step 4: Trigger deployment
          echo "ðŸš¢ Step 4/4: Triggering deployment..."

          DEPLOY_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$DOKPLOY_URL/api/compose.deploy" \
            -H "x-api-key: $DOKPLOY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg id "$DOKPLOY_COMPOSE_ID" '{composeId: $id}')")

          DEPLOY_HTTP_CODE=$(echo "$DEPLOY_RESPONSE" | tail -n1)
          DEPLOY_BODY=$(echo "$DEPLOY_RESPONSE" | sed '$d')

          if [ "$DEPLOY_HTTP_CODE" = "200" ]; then
            echo "âœ… Deployment triggered successfully"
          else
            echo "âŒ Failed to trigger deployment (HTTP $DEPLOY_HTTP_CODE)"
            echo "Response: $DEPLOY_BODY"
            exit 1
          fi
          echo ""

          # Extract deployment ID if available
          DEPLOYMENT_ID=$(echo "$DEPLOY_BODY" | jq -r '.deploymentId // empty')

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Started!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Version: $DEPLOY_VERSION"
          if [ -n "$DEPLOYMENT_ID" ]; then
            echo "Deployment ID: $DEPLOYMENT_ID"
          fi
          echo ""

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Deployment Summary

          **Environment:** `${{ steps.version.outputs.environment }}`
          **Version:** `${{ steps.version.outputs.version }}`
          **Deployment Method:** Dokploy API
          **Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ### ðŸ“¦ Deployed Images
          All services will pull: `ghcr.io/weskerllc/cronicorn/*:${{ steps.version.outputs.version }}`

          - api
          - scheduler
          - ai-planner
          - web
          - docs
          - migrator

          ### ðŸ”„ How It Works
          1. **Fetch** current Dokploy compose configuration via API
          2. **Update** `IMAGE_TAG` environment variable to `${{ github.event.inputs.version }}`
          3. **Push** updated environment back to Dokploy
          4. **Trigger** deployment via API

          ### ðŸ“ To Rollback
          Simply trigger a new deployment with the previous version tag.

          ### ðŸ”— Links
          - [Dokploy Dashboard](http://146.190.43.32:3000/dashboard)
          - [Production Site](https://cronicorn.com)
          EOF
